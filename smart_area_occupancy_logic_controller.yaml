blueprint:
  name: "ðŸ’  Smart Area Occupancy"
  description: >
    **Version: 0.99**

    This blueprint provides both a flexible and robust way to manage occupancy detection in an area that can have multiple sensors.
    You can simply just provide a single occupancy sensor and a light and the automation will take care of the rest.
    From there you can add additional sensors for entering/leaving zones, holding area detections or cleared states, delays, and more 
    to ensure occupancy of an area is always able to follow the logic you want using other sensors.


    <details>
    <summary><b>ðŸ“– Full Documentation</b></summary>


    ## ðŸŽ¯ Key Features


    - **Multi-Sensor Occupancy Logic** - Combine a single base occupancy with entering/leaving entities to create smarter occupancy logic

    - **Occupancy Holds** - Lock occupancy in detected or cleared states independent of sensors

    - **Flexible Detection Types** - Choose ANY or ALL logic for entering/leaving/hold conditions

    - **Disable Safeguards** - Pause automation entirely or only light control with fallback states

    - **State Tracking** - Optional Boolean helper and Template Sensor for monitoring outside "smart" occupancy state of the automation

    - **Template Sensor Integration** - Publish occupancy state to custom sensor via event

    - **Optional Light Control** - Built-in simple light on/off control to follow logical smart occupancy state

    - **Environmental Awareness** - Consider illuminance and sun elevation before turning on lights


    ## ðŸ“Š Occupancy State Priority


    When determining smart occupancy state, the automation checks conditions in this order:


    1. **Is Automation Disabled?** â†’ Use fallback state

    2. **Clear Hold Active?** â†’ Force occupancy OFF

    3. **Detected Hold Active OR Entering Triggered?** â†’ Force occupancy ON

    4. **Leaving Triggered?** â†’ Set occupancy OFF

    5. **Otherwise** â†’ Use base occupancy sensor state


    ## ðŸšª Occupancy Detection Types


    | Zone Type | Purpose | Logic |

    |-----------|---------|-------|

    | **Base Occupancy** | Foundation sensor (required) | Motion detector, presence sensor, etc. |

    | **Entering Zone** | Triggers detected state | Door sensors, entry motion zones, etc. |

    | **Leaving Zone** | Triggers cleared state | home away sensors, specific zone motion, etc. |

    | **Detected Hold** | Locks occupancy ON | Important activity sensors, helpers, etc. |

    | **Cleared Hold** | Locks occupancy OFF | Away mode, sleep mode, do-not-disturb |


    ## ðŸ’¡ Light Control Conditions


    Lights will only turn ON/OFF based on the following conditions:

    - Smart occupancy state ("smart" occupancy is the logic of this automation)

    - Light Control Skip is **NOT enabled** (optional if provided)

    - Illuminance thresholds (optional if provided)

    - Sun elevation thresholds (optional if enabled)


    ## ðŸŽ›ï¸ (Optional) Template Sensor


    Optionally, this automation can push events to a custom sensor to monitor the state of the automation.

    The following is an example configured template sensor in configuration.yaml:


    ### Example Template Sensor Configuration
    ```yaml

          - trigger:
              - platform: event
                event_type: "smart_occupancy_update"
            binary_sensor:
              - name: "Smart Occupancy Test"
                unique_id: smart_area_occupancy_test
                device_class: occupancy
                state: >
                  {% if trigger.event.data.target_sensor == this.entity_id %}
                    {{ trigger.event.data.state if trigger.event.data.state in ['on', 'off'] else 'off' }}
                  {% else %}
                    {{ states(this.entity_id) }}
                  {% endif %}
                availability: >
                  {% if trigger.event.data.target_sensor == this.entity_id %}
                    {{ trigger.event.data.state in ['on', 'off'] }}
                  {% else %}
                    {{ has_value(this.entity_id) }}
                  {% endif %}
            binary_sensor:
              - name: "Smart Occupancy Test 2"
                unique_id: smart_area_occupancy_test_2
                device_class: occupancy      
                ...

    ```

    ### All that is required is adjusting the unique_id and name of the sensor. The automation will handle the rest if state and availability are the same and each binary_sensor is configured to listen to the 'smart_occupancy_update' event.


    </details>
  domain: automation
  input:
    # --- Primary Targets ---
    base_occ:
      name: Base Occupancy Sensor or Helper (Required)
      description: >
        Sensor that is going to be used as a baseline for determining a room occupancy. 
        All other logic conditions will adjust the state of the smart occupancy sensor or helper based on the current state of this entity.
        Otherwise smart occupancy will follow the state of this entity if no other conditions are met.
      selector:
        entity:
          filter:
            - domain: binary_sensor
              device_class: occupancy
            - domain: input_boolean
          multiple: false

    smart_occ_helper:
      name: Smart Occupancy Boolean Helper (Optional)
      description: >
        Provide an input boolean helper if you want to track the state of the smart occupancy.
      default: []
      selector:
        entity:
          domain: input_boolean
          multiple: false

    smart_occ_sensor:
      name: Smart Occupancy Template Sensor (Optional)
      description: >
        Provide a template sensor if you want to track the state of the smart occupancy with a binary sensor.
        The sensor should be configured to listen to the 'smart_occupancy_update' event.
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: occupancy
          multiple: false

    light_target:
      name: Light Target (Optional)
      description: >
        Provide a Light, Scene, Script, or Switch that will be controlled based on the calculated smart occupancy.
      default: []
      selector:
        target:
          entity:
            domain:
              - switch
              - light
              #- scene
              #- script

    # --- Automation Controls ---
    automation_controls:
      name: Automation Controls
      icon: mdi:cog
      collapsed: true
      input:
        use_automation_control:
          name: Disable Automation Control
          description: >
            This option will add a condition to run or disable the automation.
          default: "automation_control_disabled"
          selector:
            select:
              options:
                - label: "Enable Automation Control"
                  value: "automation_control_enabled"
                - label: "Disable Automation Control"
                  value: "automation_control_disabled"

        automation_control_entity:
          name: Disable Control Entity
          description: >
            Provide an entity that will allow the automation to be disabled
          default: []
          selector:
            entity:
              multiple: false

        automation_control_state:
          name: Disable Automation Control Entity Activation State
          description: >
            Select the state the entity helper must be in to disable the automation
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        fallback_state_sensor:
          name: State of Smart Occupancy Template Sensor On Disabled
          description: >
            When the automation is disabled what state should the smart occupancy TEMPLATE SENSOR go to
          default: "unavailable"
          selector:
            select:
              options:
                - label: "On"
                  value: "on"
                - label: "Off"
                  value: "off"
                - label: "Unavailable"
                  value: "unavailable"

        use_light_skip:
          name: Light Control Skip
          description: >
            This option will add a condition to only run the smart occupancy logic portion and skip light controls.
          default: "light_control_skip_disabled"
          selector:
            select:
              options:
                - label: "Enable Light Control Skip"
                  value: "light_control_skip_enabled"
                - label: "Disable Light Control Skip"
                  value: "light_control_skip_disabled"

        light_skip_entity:
          name: Disable Light Control Entity
          description: >
            Provide an entity that will allow the Light Controls to be disabled
          default: []
          selector:
            entity:
              multiple: false

        light_skip_state:
          name: Disable Light Control Entity Activation State
          description: >
            Select the state the entity helper must be in to disable the automation
          default: "off"
          selector:
            select:
              options:
                - label: "On"
                  value: "on"
                - label: "Off"
                  value: "off"

    # --- Advance Logic Controls ---
    logic_controls:
      name: Smart Occupancy Logic Controls
      icon: mdi:brain
      collapsed: true
      input:
        smart_occ_rising_edge:
          name: Smart Occupancy Rising Edge Requirement
          description: >
            Choose which conditions will be used to determine how the smart occupancy state goes from "Cleared" to "Detected".
            Anything left unchecked will not be used to trigger the smart occupancy state even if the condtions are met.
            For example, leaving out Detected hold will not trigger the smart occupancy to go to detected, however it can still be used to hold detected state once its in there and can prevent clearing.
          default: ["base_occ", "entering", "detected_hold"]
          selector:
            select:
              multiple: true
              options:
                - label: "Base Occupancy - Detected"
                  value: "base_occ"
                - label: "Entering Conditions - ON / Match Control State"
                  value: "entering"
                - label: "Leaving Conditions - OFF / Opposite Control State"
                  value: "leaving"

        smart_occ_rising_edge_type_on:
          name: Smart Occupancy Rising Edge Detection Type - On Trigger
          description: >
            For the smart occupancy rising edge ON trigger, choose between Any or All selected conditions 
            being in their "on" state to trigger the smart occupancy to turn ON (detected state).
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        smart_occ_detected_hold_rising_edge:
          name: Smart Occupancy Detected Hold Rising Edge Trigger
          description: >
            Choose weather the detected hold will trigger a change of state to detected or only hold when the detected state from another condtion and prevent clearing if enabled.
          default: "trigger_and_hold"
          selector:
            select:
              options:
                - label: "Trigger and Hold Detection"
                  value: "trigger_and_hold"
                - label: "Hold Detection Only (Prevent Clearing)"
                  value: "hold"

        smart_occ_falling_edge:
          name: Smart Occupancy Falling Edge Requirement
          description: >
            Choose which conditions will be used to determine how the smart occupancy state goes from "Detected" to "Cleared".
            Anything left unchecked will not be used to trigger the smart occupancy state even if the condtions are met.
            For example, leaving out Leaving will not trigger the smart occupancy to go to cleared, however it can still be used to hold cleared state once its in there and can prevent detected.
          default: ["base_occ", "leaving", "cleared_hold"]
          selector:
            select:
              multiple: true
              options:
                - label: "Base Occupancy - Cleared"
                  value: "base_occ"
                - label: "Entering Conditions - OFF / Opposite Control State"
                  value: "entering"
                - label: "Leaving Conditions - ON / Match Control State"
                  value: "leaving"

        smart_occ_falling_edge_type_off:
          name: Smart Occupancy Falling Edge Detection Type - Off Trigger
          description: >
            For the smart occupancy falling edge OFF trigger, choose between Any or All selected conditions 
            being in their "off" state to allow the smart occupancy to turn ON (detected state).
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        smart_occ_cleared_hold_falling_edge:
          name: Smart Occupancy Cleared Hold Falling Edge Trigger
          description: >
            Choose whether the cleared hold will trigger a change of state to cleared or only hold when the cleared state from another condition and prevent detected if enabled.
          default: "trigger_and_hold"
          selector:
            select:
              options:
                - label: "Trigger and Hold Clear"
                  value: "trigger_and_hold"
                - label: "Hold Clear Only (Prevent Detected)"
                  value: "hold"

        #smart_occ_rising_edge_delay:
        #   name: Smart Occupancy Rising Edge Delay Time
        #   description: >
        #     Time in seconds before the smart occupancy state goes from "Cleared" to "Detected".
        #   default: 0
        #   selector:
        #     duration:

        #smart_occ_falling_edge_delay:
        #  name: Smart Occupancy Falling Edge Delay Time
        #  description: >
        #    Time before the smart occupancy state goes from "Detected" to "Cleared".
        #  default: 0
        #  selector:
        #    duration:

    # --- Occupancy Entering Conditions ---
    entering_section:
      name: Occupancy Entering Conditions
      icon: mdi:door-open
      collapsed: true
      input:
        use_entering:
          name: Use Entering Conditions
          description: >
            Use this if you want to allow entities to trigger an "Entering" condition.
          default: "use_entering_disabled"
          selector:
            select:
              options:
                - label: "Enable Entering Conditions"
                  value: "use_entering_enabled"
                - label: "Disable Entering Conditions"
                  value: "use_entering_disabled"

        entering_sensors:
          name: Entering Occupancy
          description: >
            Select a list of motion or occupancy sensors that will trigger smart occupancy to be Detected.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        entering_sensor_control_state:
          name: Entering Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Entering Conditions.
          default: "on"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        entering_type_on:
          name: Entering Occupancy Detection Type - On Trigger
          description: >
            For the entering ON trigger, choose between Any or All sensors being in the detected state 
            (matching the entering sensor control state above) to trigger Entering Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        entering_delay_on:
          name: Entering Occupancy Delay On Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to detected.
          default: 0
          selector:
            duration:

        entering_type_off:
          name: Entering Occupancy Detection Type - Off Trigger
          description: >
            For the entering OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the entering sensor control state above) to trigger Entering Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        entering_delay_off:
          name: Entering Occupancy Delay Off Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to cleared.
          default: 0
          selector:
            duration:

        #entering_duration_on_limit:
        #  name: Entering Occupancy Duration Limit
        #  description: >
        #    The maximum number of seconds the entering condition will be active. If delay on is set, duration on will begin after.
        #    If entering condition is cleared before the duration limit is reached, the entering condition will be cleared.
        #    After the duration the entering condtion will be cleared and follow base occupancy or other logic conditions.
        #    The entering condition will need to be cleared first to reset, before the entering condition can be met again.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Occupancy Leaving Conditions ---
    leaving_section:
      name: Occupancy Leaving Conditions
      icon: mdi:door-closed
      collapsed: true
      input:
        use_leaving:
          name: Use Leaving Conditions
          description: >
            Use this if you want to allow entities to trigger an "Leaving" condition.
          default: "use_leaving_disabled"
          selector:
            select:
              options:
                - label: "Enable Leaving Conditions"
                  value: "use_leaving_enabled"
                - label: "Disable Leaving Conditions"
                  value: "use_leaving_disabled"

        leaving_sensors:
          name: Leaving Occupancy
          description: >
            Select a list of motion or occupancy sensors that will trigger smart occupancy to be Cleared.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        leaving_sensor_control_state:
          name: Leaving Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Leaving Conditions.
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        leaving_type_on:
          name: Leaving Occupancy Detection Type - On Trigger
          description: >
            For the leaving ON trigger, choose between Any or All sensors being in the detected state 
            (matching the leaving sensor control state above) to trigger Leaving Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        leaving_delay_on:
          name: Leaving Occupancy Delay On Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to detected.
          default: 0
          selector:
            duration:

        leaving_type_off:
          name: Leaving Occupancy Detection Type - Off Trigger
          description: >
            For the leaving OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the leaving sensor control state above) to trigger Leaving Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        leaving_delay_off:
          name: Leaving Occupancy Delay Off Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to cleared.
          default: 0
          selector:
            duration:

        #leaving_duration_on_limit:
        #  name: Leaving Occupancy Duration Limit
        #  description: >
        #    The maximum number of seconds the leaving condition will be active. If delay on is set, duration on will begin after.
        #    If leaving condition is cleared before the duration limit is reached, the leaving condition will be cleared.
        #    After the duration the leaving condtion will be cleared and follow base occupancy or other logic conditions.
        #    The leaving condition will need to be cleared first to reset, before the leaving condition can be met again.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Detected Occupancy Hold ---
    detected_holds_section:
      name: Detected Occupancy Holds
      icon: mdi:lock-check
      collapsed: true
      input:
        use_detected_hold:
          name: Use Detected Hold Conditions
          description: >
            Enable this if you want to assign entities that will hold smart occupancy to "Detected" state.
          default: "detected_hold_disabled"
          selector:
            select:
              options:
                - label: "Enable Detected Hold Conditions"
                  value: "detected_hold_enabled"
                - label: "Disable Detected Hold Conditions"
                  value: "detected_hold_disabled"

        detected_hold_entities:
          name: Detected Occupancy Hold Entities
          description: >
            Select a list of entities that will hold smart occupancy to detected.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        detected_hold_sensor_control_state:
          name: Detected Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Detected Hold Conditions.
          default: "on"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        detected_hold_type_on:
          name: Detected Occupancy Hold Type - On Trigger
          description: >
            For the detected ON trigger, choose between Any or All sensors being in the detected state 
            (matching the detected sensor control state above) to trigger Detected Hold Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        detected_hold_delay_on:
          name: The time after the Detected Hold will delay before triggering its on state.
          description: >
            The amount of time to hold smart occupancy detected.
          default: 0
          selector:
            duration:

        detected_hold_type_off:
          name: Detected Occupancy Hold Type - Off Trigger
          description: >
            For the detected OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the detected sensor control state above) to trigger Detected Hold Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        detected_hold_delay_off:
          name: The time after the Detected Hold will delay before triggering its off state.
          description: >
            The amount of time to hold smart occupancy detected.
          default: 0
          selector:
            duration:

        #detected_hold_duration_on_limit:
        #  name: Detected Hold Duration Limit
        #  description: >
        #    The maximum number of seconds the Detected Hold condition will be active. If delay on is set, duration on will begin after.
        #    If detected hold is cleared before the duration limit is reached, the hold will be cleared.
        #    After the duration limit is reached, detected hold condtion will be cleared and follow base occupancy or other logic conditions.
        #    The detected hold will need to be cleared first to reset timer and before another hold can be completed.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Clearing Occupancy Hold ---
    cleared_holds_section:
      name: Cleared Occupancy Holds
      icon: mdi:lock-open
      collapsed: true
      input:
        use_cleared_hold:
          name: Use Clearing Hold Conditions
          description: >
            Enable this if you want to assign entities that will hold smart occupancy to "Cleared" state.
          default: "clearing_hold_disabled"
          selector:
            select:
              options:
                - label: "Enable Clearing Hold Conditions"
                  value: "clearing_hold_enabled"
                - label: "Disable Clearing Hold Conditions"
                  value: "clearing_hold_disabled"
        cleared_hold_entities:
          name: Clearing Occupancy Hold Entities
          description: >
            Select a list of entities that will hold smart occupancy to cleared.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        cleared_hold_sensor_control_state:
          name: Detected Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Clearing Hold Conditions.
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        cleared_hold_type_on:
          name: Clearing Occupancy Hold Type - On Trigger
          description: >
            For the cleared ON trigger, choose between Any or All sensors being in the cleared state 
            (matching the cleared sensor control state above) to trigger Clearing Hold Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        cleared_hold_delay_on:
          name: The time after the Clearing Hold will delay before triggering its on state.
          description: >
            The amount of time to hold smart occupancy cleared.
          default: 0
          selector:
            duration:

        cleared_hold_type_off:
          name: Clearing Occupancy Hold Type - Off Trigger
          description: >
            For the cleared OFF trigger, choose between Any or All sensors being in the cleared state 
            (matching the cleared sensor control state above) to trigger Clearing Hold Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        cleared_hold_delay_off:
          name: The time after the Clearing Hold will delay before triggering its off state.
          description: >
            The amount of time to hold smart occupancy cleared.
          default: 0
          selector:
            duration:

        #cleared_hold_duration_on_limit:
        #name: Clearing Occupancy Hold Duration
        #description: >
        #  The maximum number of seconds the Clearing Hold condition will be active. If delay on is set, duration on will begin after.
        #  If cleared hold is cleared before the duration limit is reached, the hold will be cleared.
        #  After the duration limit is reached, cleared hold condtion will be cleared and follow base occupancy or other logic conditions.
        #  The cleared hold will need to be cleared first to reset timer and before another hold can be completed.
        #  **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #  EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #default:
        #  hours: 999
        #  minutes: 0
        #  seconds: 0
        #selector:
        #  duration:

    # --- Light Control - Illuminance ---
    lux_section:
      name: Light Control - Illuminance Conditions
      icon: mdi:brightness-6
      collapsed: true
      input:
        use_lux:
          name: Use Illuminance Conditions
          description: >
            Use this if you want an illuminance sensor condition to determine if lights should turn on.
          default: "use_lux_disabled"
          selector:
            select:
              options:
                - label: "Enable Illuminance Conditions"
                  value: "use_lux_enabled"
                - label: "Disable Illuminance Conditions"
                  value: "use_lux_disabled"
        lux_sensor:
          name: Illuminance Sensor
          description: >
            Sensor used for detection of when to turn on/off lights.
          default: []
          selector:
            entity:
              domain: sensor
              device_class: illuminance
              multiple: false
        lux_low_val:
          name: Illuminance Low Lux Value
          description: >
            Set the value when the light will turn on when lux is below this value.
          default: 5
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: lux
              mode: slider
        lux_low_val_delay:
          name: Illuminance Low Lux Delay
          description: >
            Set how long the illuminance level must remain below the Low Lux Value.
          default: 0
          selector:
            duration:
        lux_high_val:
          name: Illuminance High Lux Value
          description: >
            Set the value when the light will turn off when lux is above this value.
          default: 80
          selector:
            number:
              min: 0
              max: 1000
              step: 1
              unit_of_measurement: lux
              mode: slider
        lux_high_val_delay:
          name: Illuminance High Lux Delay
          description: >
            Set how long the illuminance level must remain above the High Lux Value.
          default: 0
          selector:
            duration:

    # --- Sun Elevation ---
    sun_section:
      name: Light Control - Sun Elevation Conditions
      icon: mdi:weather-sunny
      collapsed: true
      input:
        use_sun:
          name: Use Sun Elevation Conditions
          description: >
            Use this if you want to allow the sun elevation to determine if lights should turn on.
          default: "sun_disabled"
          selector:
            select:
              options:
                - label: "Enable Sun Elevation Conditions"
                  value: "sun_enabled"
                - label: "Disable Sun Elevation Conditions"
                  value: "sun_disabled"

        sun_falling:
          name: Sun Elevation Falling
          description: >
            The sun elevation falling refers to the angle between the sun and the horizon when setting.
          default: -1.5
          selector:
            number:
              min: -90
              max: 90
              step: 0.1
              unit_of_measurement: "Â°"

        sun_rising:
          name: Sun Elevation Rising
          description: >
            The sun elevation rising refers to the angle between the sun and the horizon during sunrise.
          default: -1.5
          selector:
            number:
              min: -90
              max: 90
              step: 0.1
              unit_of_measurement: "Â°"

variables:
  base_occ: !input base_occ
  smart_occ_helper: !input smart_occ_helper
  smart_occ_sensor: !input smart_occ_sensor
  
  light_target: !input light_target
  # Split domains for light targets
  light_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  switch_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  scene_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  script_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  # --- Automation Control ---
  use_automation_control: !input use_automation_control
  automation_control_entity: !input automation_control_entity
  automation_control_state: !input automation_control_state
  fallback_state_sensor: !input fallback_state_sensor
  use_light_skip: !input use_light_skip
  light_skip_entity: !input light_skip_entity
  light_skip_state: !input light_skip_state

  # --- Smart Occupancy Logic Controls ---
  smart_occ_rising_edge: !input smart_occ_rising_edge
  smart_occ_rising_edge_type_on: !input smart_occ_rising_edge_type_on
  smart_occ_detected_hold_rising_edge: !input smart_occ_detected_hold_rising_edge

  smart_occ_falling_edge: !input smart_occ_falling_edge
  smart_occ_falling_edge_type_off: !input smart_occ_falling_edge_type_off
  smart_occ_cleared_hold_falling_edge: !input smart_occ_cleared_hold_falling_edge

  # --- Occupancy Entering Conditions ---
  use_entering: !input use_entering
  entering_sensors: !input entering_sensors
  entering_sensor_control_state: !input entering_sensor_control_state
  entering_type_on: !input entering_type_on
  entering_type_off: !input entering_type_off
  entering_delay_on: !input entering_delay_on
  entering_delay_off: !input entering_delay_off

  # --- ENTERING CONDITION STATE ---
  entering_is_on: >
    {% if entering_sensors | length == 0 %}
      false
    {% else %}
      {% set matching = expand(entering_sensors) | selectattr('state', 'eq', entering_sensor_control_state) | list | length %}
      {% set total = entering_sensors | length %}
      {{ (entering_type_on == 'any' and matching > 0) or (entering_type_on == 'all' and matching == total) }}
    {% endif %}

  entering_is_off: >
    {% if entering_sensors | length == 0 %} false
    {% else %}
      {% set matching_off = expand(entering_sensors) | selectattr('state', 'ne', entering_sensor_control_state) | list | length %}
      {% set total = entering_sensors | length %}
      {{ (entering_type_off == 'any' and matching_off > 0) or (entering_type_off == 'all' and matching_off == total) }}
    {% endif %}

  # --- Occupancy Leaving Conditions ---
  use_leaving: !input use_leaving
  leaving_sensors: !input leaving_sensors
  leaving_sensor_control_state: !input leaving_sensor_control_state
  leaving_type_on: !input leaving_type_on
  leaving_type_off: !input leaving_type_off
  leaving_delay_on: !input leaving_delay_on
  leaving_delay_off: !input leaving_delay_off

  # --- LEAVING CONDITION STATE ---
  leaving_is_on: >
    {% if leaving_sensors | length == 0 %}
      false
    {% else %}
      {% set matching = expand(leaving_sensors) | selectattr('state', 'eq', leaving_sensor_control_state) | list | length %}
      {% set total = leaving_sensors | length %}
      {{ (leaving_type_on == 'any' and matching > 0) or (leaving_type_on == 'all' and matching == total) }}
    {% endif %}

  leaving_is_off: >
    {% if leaving_sensors | length == 0 %} false
    {% else %}
      {% set matching_off = expand(leaving_sensors) | selectattr('state', 'ne', leaving_sensor_control_state) | list | length %}
      {% set total = leaving_sensors | length %}
      {{ (leaving_type_off == 'any' and matching_off > 0) or (leaving_type_off == 'all' and matching_off == total) }}
    {% endif %}

  # -- Detected Occupancy Hold ---
  use_detected_hold: !input use_detected_hold
  detected_hold_entities: !input detected_hold_entities
  detected_hold_sensor_control_state: !input detected_hold_sensor_control_state
  detected_hold_type_on: !input detected_hold_type_on
  detected_hold_type_off: !input detected_hold_type_off
  detected_hold_delay_on: !input detected_hold_delay_on
  detected_hold_delay_off: !input detected_hold_delay_off

  # --- DETECTED HOLD STATE ---
  detected_hold_is_on: >
    {% if use_detected_hold != 'detected_hold_enabled' or detected_hold_entities | length == 0 %}
      false
    {% else %}
      {% set matching = expand(detected_hold_entities) | selectattr('state', 'eq', detected_hold_sensor_control_state) | list | length %}
      {% set total = detected_hold_entities | length %}
      {{ (detected_hold_type_on == 'any' and matching > 0) or (detected_hold_type_on == 'all' and matching == total) }}
    {% endif %}

  detected_hold_is_off: >
    {% if 'detected_hold_enabled' not in use_detected_hold or detected_hold_entities | length == 0 %}
      false
    {% else %}
      {% set matching_off = expand(detected_hold_entities) | selectattr('state', 'ne', detected_hold_sensor_control_state) | list | length %}
      {% set total = detected_hold_entities | length %}
      {{ (detected_hold_type_off == 'any' and matching_off > 0) or (detected_hold_type_off == 'all' and matching_off == total) }}
    {% endif %}

  # -- Clearing Occupancy Hold ---
  use_cleared_hold: !input use_cleared_hold
  cleared_hold_entities: !input cleared_hold_entities
  cleared_hold_sensor_control_state: !input cleared_hold_sensor_control_state
  cleared_hold_type_on: !input cleared_hold_type_on
  cleared_hold_type_off: !input cleared_hold_type_off
  cleared_hold_delay_on: !input cleared_hold_delay_on
  cleared_hold_delay_off: !input cleared_hold_delay_off

  # --- CLEARED HOLD STATE ---
  cleared_hold_is_on: >
    {% if use_cleared_hold != 'clearing_hold_enabled' or cleared_hold_entities | length == 0 %}
      false
    {% else %}
      {% set matching = expand(cleared_hold_entities) | selectattr('state', 'eq', cleared_hold_sensor_control_state) | list | length %}
      {% set total = cleared_hold_entities | length %}
      {{ (cleared_hold_type_on == 'any' and matching > 0) or (cleared_hold_type_on == 'all' and matching == total) }}
    {% endif %}

  cleared_hold_is_off: >
    {% if 'clearing_hold_enabled' not in use_cleared_hold or cleared_hold_entities | length == 0 %}
      false
    {% else %}
      {% set matching_off = expand(cleared_hold_entities) | selectattr('state', 'ne', cleared_hold_sensor_control_state) | list | length %}
      {% set total = cleared_hold_entities | length %}
      {{ (cleared_hold_type_off == 'any' and matching_off > 0) or (cleared_hold_type_off == 'all' and matching_off == total) }}
    {% endif %}

  # --- SMART OCCUPANCY RISING EDGE STATE ---
  smart_occ_rising_edge_should_turn_on: >
    {% if smart_occ_rising_edge | length == 0 %}
      false
    {% else %}
      {% set active_selections = namespace(count=0) %}
      {% set conditions_met = namespace(count=0) %}

      {# 1. Base Occupancy (Must be ON to Turn ON) #}
      {% if 'base_occ' in smart_occ_rising_edge %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if is_state(base_occ, 'on') %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# 2. Entering Logic (Someone moving in helps turn it ON) #}
      {% if 'entering' in smart_occ_rising_edge and use_entering == 'use_entering_enabled' and entering_sensors | length > 0 %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if entering_is_on %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# 3. Leaving Logic (Inverse: No one leaving helps turn it ON / stay ON) #}
      {% if 'leaving' in smart_occ_rising_edge and use_leaving == 'use_leaving_enabled' and leaving_sensors | length > 0 %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if leaving_is_off %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# Final Evaluation Logic #}
      {% if active_selections.count == 0 %}
        {# If everything selected is actually disabled/empty, don't turn on #}
        false
      {% else %}
        {% set is_any = (smart_occ_rising_edge_type_on == 'any' and conditions_met.count > 0) %}
        {% set is_all = (smart_occ_rising_edge_type_on == 'all' and conditions_met.count == active_selections.count) %}
        {{ is_any or is_all }}
      {% endif %}
    {% endif %}

  # --- SMART OCCUPANCY FALLING EDGE STATE ---
  smart_occ_falling_edge_should_turn_off: >
    {% if smart_occ_falling_edge | length == 0 %}
      false
    {% else %}
      {% set active_selections = namespace(count=0) %}
      {% set conditions_met = namespace(count=0) %}

      {# 1. Base Occupancy #}
      {% if 'base_occ' in smart_occ_falling_edge %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if is_state(base_occ, 'off') %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# 2. Entering Logic #}
      {% if 'entering' in smart_occ_falling_edge and use_entering == 'use_entering_enabled' and entering_sensors | length > 0 %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if entering_is_off %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# 3. Leaving Logic #}
      {% if 'leaving' in smart_occ_falling_edge and use_leaving == 'use_leaving_enabled' and leaving_sensors | length > 0 %}
        {% set active_selections.count = active_selections.count + 1 %}
        {% if leaving_is_on %}
          {% set conditions_met.count = conditions_met.count + 1 %}
        {% endif %}
      {% endif %}

      {# Final Evaluation #}
      {% if active_selections.count == 0 %}
        false
      {% else %}
        {% set is_any = (smart_occ_falling_edge_type_off == 'any' and conditions_met.count > 0) %}
        {% set is_all = (smart_occ_falling_edge_type_off == 'all' and conditions_met.count == active_selections.count) %}
        {{ is_any or is_all }}
      {% endif %}
    {% endif %}

  # -- Light Control - Illuminance ---
  use_lux: !input use_lux
  lux_sensor: !input lux_sensor
  lux_low_val: !input lux_low_val
  lux_low_val_delay: !input lux_low_val_delay
  lux_high_val: !input lux_high_val
  lux_high_val_delay: !input lux_high_val_delay

  # -- Light Control - Sun Elevation ---
  use_sun: !input use_sun
  sun_falling: !input sun_falling
  sun_rising: !input sun_rising

triggers:
  - alias: Base Occupancy ON Trigger
    trigger: state
    id: base occupancy on
    entity_id: !input base_occ
    to: "on"
  - alias: Base Occupancy OFF Trigger
    trigger: state
    id: base occupancy off
    entity_id: !input base_occ
    to: "off"
  - alias: Automation Control Enabled
    trigger: state
    id: automation enabled
    entity_id: !input automation_control_entity
    from: !input automation_control_state
  - alias: Automation Control Disabled
    id: automation disabled
    trigger: state
    entity_id: !input automation_control_entity
    to: !input automation_control_state
  #- alias: Rising Edge Trigger (with Delay)
  #  trigger: state
  #  id: rising edge
  #  entity_id:
  #    - !input entering_sensors
  #    - !input leaving_sensors
  #    - !input detected_hold_entities
  #    - !input cleared_hold_entities
  #  from:
  #    - "off"
  #    - unavailable
  #  to:
  #    - "on"
  #  for: !input smart_occ_rising_delay
  #- alias: Falling Edge Trigger (with Delay)
  #  trigger: state
  #  id: falling edge
  #  entity_id:
  #    - !input entering_sensors
  #    - !input leaving_sensors
  #    - !input detected_hold_entities
  #    - !input cleared_hold_entities
  #  from:
  #    - "on"
  #  to:
  #    - "off"
  #  for: !input smart_occ_falling_delay
  - alias: Entering ON (with Delay)
    trigger: state
    id: entering on
    entity_id: !input entering_sensors
    to: !input entering_sensor_control_state
    for: !input entering_delay_on
  - alias: Entering OFF (with Delay)
    trigger: state
    id: entering off
    entity_id: !input entering_sensors
    from: !input entering_sensor_control_state
    for: !input entering_delay_off
  #- alias: Entering ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: entering off
  #  entity_id: !input entering_sensors
  #  to:
  #    - "on" #when on for limit it will trigger entering off id path
  #  for: !input entering_duration_on_limit
  - alias: Leaving ON (with Delay)
    trigger: state
    id: leaving on
    entity_id: !input leaving_sensors
    to: !input leaving_sensor_control_state
    for: !input leaving_delay_on
  - alias: Leaving OFF (with Delay)
    trigger: state
    id: leaving off
    entity_id: !input leaving_sensors
    from: !input leaving_sensor_control_state
    for: !input leaving_delay_off
  #- alias: Leaving ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: leaving off
  #  entity_id: !input leaving_sensors
  #  to:
  #    - "on" #when on for limit it will trigger leaving off id path
  #  for: !input leaving_duration_on_limit
  - alias: Detected Hold ON (with Delay)
    trigger: state
    id: detected hold on
    entity_id: !input detected_hold_entities
    to: !input detected_hold_sensor_control_state
    for: !input detected_hold_delay_on
  - alias: Detected Hold OFF (with Delay)
    trigger: state
    id: detected hold off
    entity_id: !input detected_hold_entities
    from: !input detected_hold_sensor_control_state
    for: !input detected_hold_delay_off
  #- alias: Detected Hold ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: detected hold off
  #  entity_id: !input detected_hold_entities
  #  to:
  #    - "on" #when on for limit it will trigger detected hold off id path
  #  for: !input detected_hold_duration_on_limit
  - alias: Clear Hold ON (with Delay)
    trigger: state
    id: clear hold on
    entity_id: !input cleared_hold_entities
    to: !input cleared_hold_sensor_control_state
    for: !input cleared_hold_delay_on
  - alias: Clear Hold OFF (with Delay)
    trigger: state
    id: clear hold off
    entity_id: !input cleared_hold_entities
    from: !input cleared_hold_sensor_control_state
    for: !input cleared_hold_delay_off
  #- alias: Clear Hold ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: clear hold off
  #  to:
  #    - "on"
  #  for: !input cleared_hold_duration_on_limit #when on for limit it will trigger detected hold off id path
  - trigger: state
    entity_id: !input light_skip_entity
    to: !input light_skip_state
    id: light control enabled
  - trigger: state
    entity_id: !input light_skip_entity
    from: !input light_skip_state
    id: light control disabled
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    below: !input sun_falling
    alias: When Elevation from Sun is below is below setting threshold
    id: sun setting threshold
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: !input sun_rising
    alias: When Elevation from Sun is above rising threshold
    id: sun rising threshold
  - trigger: numeric_state
    entity_id: !input lux_sensor
    below: !input lux_low_val
    id: illuminance low limit
  - trigger: numeric_state
    entity_id: !input lux_sensor
    id: illuminance high limit
    above: !input lux_high_val

#Trigger Conditions
conditions:
  - alias: Trigger Conditions
    condition: or
    conditions:
      - alias: Automation Re-Enabled
        condition: and
        conditions:
          - "{{ 'automation_control_enabled' in use_automation_control }}"
          - condition: trigger
            id:
              - automation enabled
          - condition: template
            value_template: "{{ automation_control_entity | length > 0 }}"
      
      - alias: Automation Disabled
        condition: and
        conditions:
          - condition: trigger
            id:
              - automation disabled
          - "{{ 'automation_control_enabled' in use_automation_control }}"
          - condition: template
            value_template: "{{ automation_control_entity | length > 0 }}"
      
      # ============================================================================
      # RISING EDGE TRIGGERS (Should turn ON)
      # ============================================================================
      
      - alias: Base Occupancy - Detected (Only if currently OFF)
        condition: and
        conditions:
          - condition: trigger
            id: "base occupancy on"
          - condition: and
            alias: "Smart Occ is currently OFF"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'off') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"
      
      - alias: Entering ON (Only if currently OFF and rising edge allows it)
        condition: and
        conditions:
          - "{{ 'use_entering_enabled' in use_entering }}"
          - condition: trigger
            id: "entering on"
          - condition: template
            value_template: "{{ entering_sensors | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ entering_is_on and not entering_is_off }}" #if both match then trigger will skip and stay in its last state (entering on cant be true and trigger if entering off is still true)
          - condition: and
            alias: "Smart Occ is currently OFF"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'off') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"
          - "{{ 'entering' in smart_occ_rising_edge }}"
          # --- Logic is now covered in entering_is_off/_on and condtion above ---
          #- condition: template
          #  alias: "Check Entering Group logic (Any/All vs Control State)"
          #  value_template: >
          #    {% set matching = expand(entering_sensors) | selectattr('state', 'eq', entering_sensor_control_state) | list | length %}
          #    {% set total = entering_sensors | length %}
          #    {{ (entering_type_on == 'any' and matching > 0) or (entering_type_on == 'all' and matching == total) }}
      
      - alias: Leaving OFF (Only if currently OFF and rising edge allows it)
        condition: and
        conditions:
          - "{{ 'use_leaving_enabled' in use_leaving }}"
          - condition: trigger
            id: "leaving off"
          - condition: template
            value_template: "{{ leaving_sensors | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ leaving_is_off and not leaving_is_on }}"  #if both match then trigger will skip and stay in its last state (leaving off cant be true and trigger if leaving on is still true)
          - condition: and
            alias: "Smart Occ is currently OFF"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'off') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"
          - "{{ 'leaving' in smart_occ_rising_edge }}"
          # --- Logic is now covered in leaving_is_off/_on and condtion above ---
          #- condition: template
          #  alias: "Check Leaving Group logic (Inverse of Control State)"
          #  value_template: >
          #    {% set opposite_state = 'off' if leaving_sensor_control_state == 'on' else 'on' %}
          #    {% set matching = expand(leaving_sensors) | selectattr('state', 'eq', opposite_state) | list | length %}
          #    {% set total = leaving_sensors | length %}
          #    {{ (leaving_type_on == 'any' and matching > 0) or (leaving_type_on == 'all' and matching == total) }}
      
      - alias: Detected Hold ON (Only if currently OFF or can trigger)
        condition: and
        conditions:
          - "{{ 'detected_hold_enabled' in use_detected_hold }}"
          - condition: trigger
            id: "detected hold on"
          - condition: template
            value_template: "{{ detected_hold_entities | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ detected_hold_is_on and not detected_hold_is_off }}"
          - condition: or
            conditions:
              # Can trigger if set to rising_edge mode
              - condition: template
                value_template: "{{ smart_occ_detected_hold_rising_edge == 'trigger_and_hold' }}"
              # Or if just holding and smart_occ is already ON
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ smart_occ_detected_hold_rising_edge == 'hold' }}"
                  - condition: and
                    conditions:
                      - condition: template
                        value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'on') }}"
                      - condition: template
                        value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'on') }}"

      - alias: Cleared Hold Off / Released (Only if currently OFF or can trigger)
        condition: and
        conditions:
          - "{{ 'clearing_hold_enabled' in use_cleared_hold }}"
          - condition: trigger
            id: "clear hold off"
          - condition: template
            value_template: "{{ cleared_hold_entities | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ cleared_hold_is_off and not cleared_hold_is_on }}"
          - condition: and
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'off') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"
      
      # ============================================================================
      # FALLING EDGE TRIGGERS (Should turn OFF)
      # ============================================================================
      
      - alias: Base Occupancy - Cleared (Only if currently ON)
        condition: and
        conditions:
          - condition: trigger
            id: "base occupancy off"
          - condition: and
            alias: "Smart Occ is currently ON"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'on') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'on') }}"
      
      - alias: Entering OFF (Only if currently ON and falling edge allows it)
        condition: and
        conditions:
          - "{{ 'use_entering_enabled' in use_entering }}"
          - condition: trigger
            id: "entering off"
          - condition: template
            value_template: "{{ entering_sensors | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ entering_is_off and not entering_is_on }}"
          - condition: or
            alias: "Smart Occ is currently ON"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length > 0 and is_state(smart_occ_sensor, 'on') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length > 0 and is_state(smart_occ_helper, 'on') }}"
          - "{{ 'entering' in smart_occ_falling_edge }}"
          #- condition: template
          #  alias: "Check Entering Group logic (Inverse for Falling Edge)"
          #  value_template: >
          #    {% set opposite_state = 'off' if entering_sensor_control_state == 'on' else 'on' %}
          #    {% set matching = expand(entering_sensors) | selectattr('state', 'eq', opposite_state) | list | length %}
          #    {% set total = entering_sensors | length %}
          #    {{ (entering_type_off == 'any' and matching > 0) or (entering_type_off == 'all' and matching == total) }}
      
      - alias: Leaving ON (Only if currently ON and falling edge allows it)
        condition: and
        conditions:
          - "{{ 'use_leaving_enabled' in use_leaving }}"
          - condition: trigger
            id: "leaving on"
          - condition: template
            value_template: "{{ leaving_sensors | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ leaving_is_on and not leaving_is_off }}"
          - condition: or
            alias: "Smart Occ is currently ON"
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length > 0 and is_state(smart_occ_sensor, 'on') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length > 0 and is_state(smart_occ_helper, 'on') }}"
          - "{{ 'leaving' in smart_occ_falling_edge }}"
          # --- Logic: Sensors must match the 'Leaving' control state ---
          #- condition: template
          #  alias: "Check Leaving Group logic (Match Control State for Falling Edge)"
          #  value_template: >
          #    {% set matching = expand(leaving_sensors) | selectattr('state', 'eq', leaving_sensor_control_state) | list | length %}
          #    {% set total = leaving_sensors | length %}
          #    {{ (leaving_type_off == 'any' and matching > 0) or (leaving_type_off == 'all' and matching == total) }}

      - alias: Detected Hold OFF / Relased (Only if currently ON or can trigger)
        condition: and
        conditions:
          - "{{ 'detected_hold_enabled' in use_detected_hold }}"
          - condition: trigger
            id: "detected hold off"
          - condition: template
            value_template: "{{ detected_hold_entities | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ detected_hold_is_off and not detected_hold_is_on }}"
          - condition: and
            conditions:
              - condition: template
                value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'on') }}"
              - condition: template
                value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'on') }}"
      
      - alias: Cleared Hold ON (Only if currently ON or can trigger)
        condition: and
        conditions:
          - "{{ 'clearing_hold_enabled' in use_cleared_hold }}"
          - condition: trigger
            id: "clear hold on"
          - condition: template
            value_template: "{{ cleared_hold_entities | length > 0 }}"
          - condition: template
            alias: "Ensure logic is valid (Not in a dead-zone)"
            value_template: "{{ cleared_hold_is_on and not cleared_hold_is_off }}"
          - condition: or
            conditions:
              # Can trigger if set to trigger_and_hold mode
              - condition: template
                value_template: "{{ smart_occ_cleared_hold_falling_edge == 'trigger_and_hold' }}"
              # Or if just holding and smart_occ is already OFF
              - condition: and
                conditions:
                  - condition: template
                    value_template: "{{ smart_occ_cleared_hold_falling_edge == 'hold' }}"
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ smart_occ_sensor | length == 0 or is_state(smart_occ_sensor, 'off') }}"
                      - condition: template
                        value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"
      
      # ============================================================================
      # ENVIRONMENTAL TRIGGERS (Light control)
      # ============================================================================
      
      - alias: Illuminance Thresholds
        condition: and
        conditions:
          - condition: template
            value_template: >
              {{ 'use_lux_enabled' in use_lux 
                 and lux_sensor | length > 0 }}
          - condition: trigger
            id:
              - illuminance high limit
              - illuminance low limit
          - condition: template
            value_template: >
              {{ 'light_control_skip_disabled' in use_light_skip
                 or light_skip_entity | length == 0
                 or (light_skip_entity | length > 0 
                     and not is_state(light_skip_entity, light_skip_state)) }}
      
      - alias: Sun Elevation Thresholds
        condition: and
        conditions:
          - condition: template
            value_template: "{{ 'sun_enabled' in use_sun }}"
          - condition: or
            conditions:
              - condition: template
                value_template: >
                  {{ (use_sun == 'sun_enabled') 
                     and (is_state_attr('sun.sun', 'rising', false)) 
                     and (state_attr('sun.sun','elevation') <= sun_falling | float(90)) }}
              - condition: template
                value_template: >
                  {{ (use_sun == 'sun_enabled') 
                     and (is_state_attr('sun.sun', 'rising', true)) 
                     and (state_attr('sun.sun','elevation') <= sun_rising | float(90)) }}
          - condition: trigger
            id:
              - sun setting threshold
              - sun rising threshold
          - condition: template
            value_template: >
              {{ 'light_control_skip_disabled' in use_light_skip
                 or light_skip_entity | length == 0
                 or (light_skip_entity | length > 0 
                     and not is_state(light_skip_entity, light_skip_state)) }}
  
  - alias: Automation Control - Enabled
    condition: or
    conditions:
      - alias: Check if Automation Control is bypassed
        condition: template
        value_template: "{{ use_automation_control == 'automation_control_disabled' }}"
      - alias: Check if Entity State does NOT match Control State and Automation Control is enabled
        condition: template
        value_template: >
          {{ use_automation_control == 'automation_control_enabled' and 
            not is_state(automation_control_entity, automation_control_state) }}
      - alias: Automation Disabled Triggered
        condition: trigger
        id:
          - automation disabled

actions:
  - variables:
      # 1. Find Current State
      current_state: >
        {% if smart_occ_sensor | length > 0 %} {{ states(smart_occ_sensor) }}
        {% elif smart_occ_helper | length > 0 %} {{ states(smart_occ_helper) }}
        {% else %} {{ states(base_occ) }}
        {% endif %}

      # 2. Logic Result Logic
      # Check if Rising and Falling are different. If both true or both false, 'gate_open' is false.
      gate_open: "{{ smart_occ_rising_edge_should_turn_on != smart_occ_falling_edge_should_turn_off }}"

      # 3. Final Calculation
      calc_smart_occ: >
        {# Priority 1: Safety/Override Controls #}
        {% if use_automation_control == 'automation_control_enabled' and is_state(automation_control_entity, automation_control_state) %}
          off
        {% elif detected_hold_is_on and not detected_hold_is_off and not cleared_hold_is_on and smart_occ_detected_hold_rising_edge == 'trigger_and_hold' %}
          on
        {% elif cleared_hold_is_on and not cleared_hold_is_off and not detected_hold_is_on and smart_occ_cleared_hold_falling_edge == 'trigger_and_hold' %}
          off
        
        {# Priority 2: Edge Logic (Only if not in a conflict state) #}
        {% elif gate_open and smart_occ_rising_edge_should_turn_on %}
          on
        {% elif gate_open and smart_occ_falling_edge_should_turn_off %}
          off

        {# Priority 3: The "All Clear" Check #}
        {# If nothing is holding it ON and the room is empty/cleared, force OFF #}
        {% elif not detected_hold_is_on and not smart_occ_rising_edge_should_turn_on and not smart_occ_falling_edge_should_turn_off %}
          off

        {# Priority 4: Conflict Fallback (Latch) #}
        {# This triggers if Rising and Falling are BOTH true, or BOTH false but not fully "cleared" #}
        {% else %}
          {{ current_state }}
        {% endif %}

  # ============================================================================
  # STEP 1: Update the Smart Occupancy State (Sensor and/or Helper)
  # ============================================================================
  - alias: "Update Smart Occupancy State"
    if:
      - condition: template
        alias: "Only if something actually changed"
        value_template: "{{ current_state != calc_smart_occ }}"
    then:
      # Update the Virtual Sensor (via Event)
      - if:
          - "{{ smart_occ_sensor | length > 0 }}"
        then:
          - event: smart_occupancy_update
            event_data:
              target_sensor: "{{ smart_occ_sensor }}"
              state: "{{ calc_smart_occ }}"
              # You can still pass metadata for debugging if you wish:
              trigger_id: "{{ trigger.id }}"
              base_state: "{{ states(base_occ) }}"

      # Update the Input Boolean Helper
      - if:
          - "{{ smart_occ_helper | length > 0 }}"
        then:
          - service: "input_boolean.turn_{{ calc_smart_occ }}"
            target:
              entity_id: "{{ smart_occ_helper }}"

  # ============================================================================
  # STEP 2: Light Control
  # ============================================================================
  - alias: If Light Control is Enabled
    if:
      - condition: template
        value_template: >
          {{ 'light_control_skip_disabled' in use_light_skip
             or light_skip_entity | length == 0
             or (light_skip_entity | length > 0 
              and not is_state(light_skip_entity, light_skip_state)) }}
    then:
      # ============================================================================
      # TURN LIGHTS ON - When calculated smart occupancy is ON
      # ============================================================================
      - alias: "Light On - Follow Smart Occupancy"
        if:
          - condition: template
            alias: "Calculated state is ON"
            value_template: "{{ calc_smart_occ == 'on' }}"
          
          # Environmental conditions for turning ON
          - condition: and
            conditions:
              # --- SUN SECTION ---
              - alias: "Sun Logic (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - alias: Use Sun is disabled
                    condition: template
                    value_template: "{{ use_sun == 'sun_disabled' }}"
                  - alias: Sun Elevation Conditions Met
                    condition: and
                    conditions:
                      - alias: If sun is setting and below threshold
                        condition: or
                        conditions:
                          - condition: state
                            entity_id: sun.sun
                            attribute: rising
                            state: false
                          - condition: numeric_state
                            entity_id: sun.sun
                            attribute: elevation
                            below: !input sun_falling
                      - alias: If sun is rising and below threshold
                        condition: or
                        conditions:
                          - condition: state
                            entity_id: sun.sun
                            attribute: rising
                            state: true
                          - condition: numeric_state
                            entity_id: sun.sun
                            attribute: elevation
                            below: !input sun_rising
              
              # --- LUX SECTION ---
              - alias: "Lux Logic (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - alias: Use Lux is disabled
                    condition: template
                    value_template: "{{ use_lux == 'use_lux_disabled' or lux_sensor | length == 0 }}"
                  - alias: Illuminance is below threshold
                    condition: numeric_state
                    entity_id: !input lux_sensor
                    below: !input lux_low_val
        then:
          # Turn on lights
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ light_entities | length > 0 }}"
                sequence:
                  - action: light.turn_on
                    target:
                      entity_id: "{{ light_entities }}"
          # Turn on switches
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ switch_entities | length > 0 }}"
                sequence:
                  - action: switch.turn_on
                    target:
                      entity_id: "{{ switch_entities }}"
          # Activate scenes
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ scene_entities | length > 0 }}"
                sequence:
                  - action: scene.turn_on
                    target:
                      entity_id: "{{ scene_entities }}"
          # Run scripts
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ script_entities | length > 0 }}"
                sequence:
                  - action: script.turn_on
                    target:
                      entity_id: "{{ script_entities }}"

      # ============================================================================
      # TURN LIGHTS OFF - When calculated smart occupancy is OFF
      # ============================================================================
      - alias: "Light Off - Follow Smart Occupancy"
        if:
          - condition: template
            alias: "Calculated state is OFF"
            value_template: "{{ calc_smart_occ == 'off' }}"
          
          # Environmental conditions for turning OFF
          - condition: and
            conditions:
              # --- SUN SECTION ---
              - alias: "Sun Logic Off (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - condition: template
                    alias: "Sun is disabled"
                    value_template: "{{ use_sun == 'sun_disabled' }}"
                  - alias: "Sun Elevation allows OFF"
                    condition: and
                    conditions:
                      - alias: "Sun is high enough (setting)"
                        condition: or
                        conditions:
                          - condition: state
                            entity_id: sun.sun
                            attribute: rising
                            state: true
                          - condition: numeric_state
                            entity_id: sun.sun
                            attribute: elevation
                            above: !input sun_falling
                      - alias: "Sun is high enough (rising)"
                        condition: or
                        conditions:
                          - condition: state
                            entity_id: sun.sun
                            attribute: rising
                            state: false
                          - condition: numeric_state
                            entity_id: sun.sun
                            attribute: elevation
                            above: !input sun_rising

              # --- LUX SECTION ---
              - alias: "Lux Logic Off (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - condition: template
                    alias: "Lux is disabled"
                    value_template: "{{ 'use_lux_enabled' not in use_lux or lux_sensor | length == 0 }}"
                  - alias: "Illuminance is above threshold"
                    condition: numeric_state
                    entity_id: !input lux_sensor
                    above: !input lux_high_val
        then:
          # Turn off lights
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ light_entities | length > 0 }}"
                sequence:
                  - action: light.turn_off
                    target:
                      entity_id: "{{ light_entities }}"
          # Turn off switches
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ switch_entities | length > 0 }}"
                sequence:
                  - action: switch.turn_off
                    target:
                      entity_id: "{{ switch_entities }}"

mode: single
