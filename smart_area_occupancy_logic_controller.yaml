blueprint:
  name: "ðŸ’  TESTING Smart Area Occupancy"
  description: >
    **Version: 1.0**

    This blueprint provides both a flexible and robust way to manage occupancy detection in an area that can have multiple sensors.
    You can simply just provide a single occupancy sensor and a light and the automation will take care of the rest.
    From there you can add additional sensors for entering/leaving zones, holding area detections or cleared states, delays, and more 
    to ensure occupancy of an area is always able to follow the logic you want using other sensors.


    <details>
    <summary><b>ðŸ“– Full Documentation</b></summary>


    ## ðŸŽ¯ Key Features


    - **Multi-Sensor Occupancy Logic** - Combine a single base occupancy with entering/leaving entities to create smarter occupancy logic

    - **Occupancy Holds** - Lock occupancy in detected or cleared states independent of sensors

    - **Flexible Detection Types** - Choose ANY or ALL logic for entering/leaving/hold conditions

    - **Disable Safeguards** - Pause automation entirely or only light control with fallback states

    - **State Tracking** - Optional Boolean helper and Template Sensor for monitoring outside "smart" occupancy state of the automation

    - **Template Sensor Integration** - Publish occupancy state to custom sensor via event

    - **Optional Light Control** - Built-in simple light on/off control to follow logical smart occupancy state

    - **Environmental Awareness** - Consider illuminance and sun elevation before turning on lights


    ## ðŸ“Š Occupancy State Priority


    When determining smart occupancy state, the automation checks conditions in this order:


    1. **Is Automation Disabled?** â†’ Use fallback state

    2. **Clear Hold Active?** â†’ Force occupancy OFF

    3. **Detected Hold Active OR Entering Triggered?** â†’ Force occupancy ON

    4. **Leaving Triggered?** â†’ Set occupancy OFF

    5. **Otherwise** â†’ Use base occupancy sensor state


    ## ðŸšª Occupancy Detection Types


    | Zone Type | Purpose | Logic |

    |-----------|---------|-------|

    | **Base Occupancy** | Foundation sensor (required) | Motion detector, presence sensor, etc. |

    | **Entering Zone** | Triggers detected state | Door sensors, entry motion zones, etc. |

    | **Leaving Zone** | Triggers cleared state | home away sensors, specific zone motion, etc. |

    | **Detected Hold** | Locks occupancy ON | Important activity sensors, helpers, etc. |

    | **Cleared Hold** | Locks occupancy OFF | Away mode, sleep mode, do-not-disturb |


    ## ðŸ’¡ Light Control Conditions


    Lights will only turn ON/OFF based on the following conditions:

    - Smart occupancy state ("smart" occupancy is the logic of this automation)

    - Light Control Skip is **NOT enabled** (optional if provided)

    - Illuminance thresholds (optional if provided)

    - Sun elevation thresholds (optional if enabled)


    ## ðŸŽ›ï¸ (Optional) Template Sensor


    Optionally, this automation can push events to a custom sensor to monitor the state of the automation.

    The following is an example configured template sensor in configuration.yaml:


    ### Example Template Sensor Configuration
    ```yaml

          - trigger:
              - platform: event
                event_type: "smart_occupancy_update"
            binary_sensor:
              - name: "Smart Occupancy Test"
                unique_id: smart_area_occupancy_test
                device_class: occupancy
                state: >
                  {% if trigger.event.data.target_sensor == this.entity_id %}
                    {{ trigger.event.data.state if trigger.event.data.state in ['on', 'off'] else 'off' }}
                  {% else %}
                    {{ states(this.entity_id) }}
                  {% endif %}
                availability: >
                  {% if trigger.event.data.target_sensor == this.entity_id %}
                    {{ trigger.event.data.state in ['on', 'off'] }}
                  {% else %}
                    {{ has_value(this.entity_id) }}
                  {% endif %}
            binary_sensor:
              - name: "Smart Occupancy Test 2"
                unique_id: smart_area_occupancy_test_2
                device_class: occupancy      
                ...

    ```

    ### All that is required is adjusting the unique_id and name of the sensor. The automation will handle the rest if state and availability are the same and each binary_sensor is configured to listen to the 'smart_occupancy_update' event.


    </details>
  domain: automation
  input:
    # --- Primary Targets ---
    base_occ:
      name: Base Occupancy Sensor or Helper (Required)
      description: >
        Sensor that is going to be used as a baseline for determining a room occupancy. 
        All other logic conditions will adjust the state of the smart occupancy sensor or helper based on the current state of this entity.
        Otherwise smart occupancy will follow the state of this entity if no other conditions are met.
      selector:
        entity:
          filter:
            - domain: binary_sensor
              device_class: occupancy
            - domain: input_boolean
          multiple: false

    smart_occ_helper:
      name: Smart Occupancy Boolean Helper (Optional)
      description: >
        Provide an input boolean helper if you want to track the state of the smart occupancy.
      default: []
      selector:
        entity:
          domain: input_boolean
          multiple: false

    smart_occ_sensor:
      name: Smart Occupancy Template Sensor (Optional)
      description: >
        Provide a template sensor if you want to track the state of the smart occupancy with a binary sensor.
        The sensor should be configured to listen to the 'smart_occupancy_update' event.
      default: []
      selector:
        entity:
          domain: binary_sensor
          device_class: occupancy
          multiple: false

    light_target:
      name: Light Target (Optional)
      description: >
        Provide a Light, Scene, Script, or Switch that will be controlled based on the calculated smart occupancy.
      default: []
      selector:
        target:
          entity:
            domain:
              - switch
              - light
              #- scene
              #- script

    # --- Automation Controls ---
    automation_controls:
      name: Automation Controls
      icon: mdi:cog
      collapsed: true
      input:
        use_automation_control:
          name: Disable Automation Control
          description: >
            This option will add a condition to run or disable the automation.
          default: "automation_control_disabled"
          selector:
            select:
              options:
                - label: "Enable Automation Control"
                  value: "automation_control_enabled"
                - label: "Disable Automation Control"
                  value: "automation_control_disabled"

        automation_control_entity:
          name: Disable Control Entity
          description: >
            Provide an entity that will allow the automation to be disabled
          default: []
          selector:
            entity:
              multiple: false

        automation_control_state:
          name: Disable Automation Control Entity Activation State
          description: >
            Select the state the entity helper must be in to disable the automation
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        fallback_state_sensor:
          name: State of Smart Occupancy Template Sensor On Disabled
          description: >
            When the automation is disabled what state should the smart occupancy TEMPLATE SENSOR go to
          default: "unavailable"
          selector:
            select:
              options:
                - label: "On"
                  value: "on"
                - label: "Off"
                  value: "off"
                - label: "Unavailable"
                  value: "unavailable"

        use_light_skip:
          name: Light Control Skip
          description: >
            This option will add a condition to only run the smart occupancy logic portion and skip light controls.
          default: "light_control_skip_disabled"
          selector:
            select:
              options:
                - label: "Enable Light Control Skip"
                  value: "light_control_skip_enabled"
                - label: "Disable Light Control Skip"
                  value: "light_control_skip_disabled"

        light_skip_entity:
          name: Disable Light Control Entity
          description: >
            Provide an entity that will allow the Light Controls to be disabled
          default: []
          selector:
            entity:
              multiple: false

        light_skip_state:
          name: Disable Light Control Entity Activation State
          description: >
            Select the state the entity helper must be in to disable the automation
          default: "off"
          selector:
            select:
              options:
                - label: "On"
                  value: "on"
                - label: "Off"
                  value: "off"

    # --- Advance Logic Controls ---
    logic_controls:
      name: Smart Occupancy Logic Controls
      icon: mdi:brain
      collapsed: true
      input:
        smart_occ_rising_edge:
          name: Smart Occupancy Rising Edge Requirement
          description: >
            Choose which conditions will be used to determine how the smart occupancy state goes from "Cleared" to "Detected".
            Anything left unchecked will not be used to trigger the smart occupancy state even if the condtions are met.
            For example, leaving out Detected hold will not trigger the smart occupancy to go to detected, however it can still be used to hold detected state once its in there and can prevent clearing.
          default: ["base_occ", "entering", "detected_hold"]
          selector:
            select:
              multiple: true
              options:
                - label: "Base Occupancy - Detected"
                  value: "base_occ"
                - label: "Entering Conditions - ON / Match Control State"
                  value: "entering"
                - label: "Leaving Conditions - OFF / Opposite Control State"
                  value: "leaving"

        smart_occ_detected_hold_rising_edge:
          name: Smart Occupancy Detected Hold Rising Edge Trigger
          description: >
            Choose weather the detected hold will trigger a change of state to detected or only hold when the detected state from another condtion and prevent clearing if enabled.
          default: "rising_edge"
          selector:
            select:
              options:
                - label: "Trigger and Hold Detection"
                  value: "rising_edge"
                - label: "Hold Detection Only (Prevent Clearing)"
                  value: "hold"

        smart_occ_falling_edge:
          name: Smart Occupancy Falling Edge Requirement
          description: >
            Choose which conditions will be used to determine how the smart occupancy state goes from "Detected" to "Cleared".
            Anything left unchecked will not be used to trigger the smart occupancy state even if the condtions are met.
            For example, leaving out Leaving will not trigger the smart occupancy to go to cleared, however it can still be used to hold cleared state once its in there and can prevent detected.
          default: ["base_occ", "leaving", "cleared_hold"]
          selector:
            select:
              multiple: true
              options:
                - label: "Base Occupancy - Cleared"
                  value: "base_occ"
                - label: "Entering Conditions - OFF / Opposite Control State"
                  value: "entering"
                - label: "Leaving Conditions - ON / Match Control State"
                  value: "leaving"

        smart_occ_cleared_hold_rising_edge:
          name: Smart Occupancy Cleared Hold Rising Edge Trigger
          description: >
            Choose weather the cleared hold will trigger a change of state to cleared or only hold when the cleared state from another condtion and prevent detected if enabled.
          default: "trigger_and_hold"
          selector:
            select:
              options:
                - label: "Trigger and Hold Clear"
                  value: "trigger_and_hold"
                - label: "Hold Clear Only (Prevent Detected)"
                  value: "hold"

        #smart_occ_rising_edge_delay:
        #   name: Smart Occupancy Rising Edge Delay Time
        #   description: >
        #     Time in seconds before the smart occupancy state goes from "Cleared" to "Detected".
        #   default: 0
        #   selector:
        #     duration:

        #smart_occ_falling_edge_delay:
        #  name: Smart Occupancy Falling Edge Delay Time
        #  description: >
        #    Time before the smart occupancy state goes from "Detected" to "Cleared".
        #  default: 0
        #  selector:
        #    duration:

    # --- Occupancy Entering Conditions ---
    entering_section:
      name: Occupancy Entering Conditions
      icon: mdi:door-open
      collapsed: true
      input:
        use_entering:
          name: Use Entering Conditions
          description: >
            Use this if you want to allow entities to trigger an "Entering" condition.
          default: "use_entering_disabled"
          selector:
            select:
              options:
                - label: "Enable Entering Conditions"
                  value: "use_entering_enabled"
                - label: "Disable Entering Conditions"
                  value: "use_entering_disabled"

        entering_sensors:
          name: Entering Occupancy
          description: >
            Select a list of motion or occupancy sensors that will trigger smart occupancy to be Detected.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        entering_sensor_control_state:
          name: Entering Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Entering Conditions.
          default: "on"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        entering_type_on:
          name: Entering Occupancy Detection Type - On Trigger
          description: >
            For the entering ON trigger, choose between Any or All sensors being in the detected state 
            (matching the entering sensor control state above) to trigger Entering Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        entering_delay_on:
          name: Entering Occupancy Delay On Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to detected.
          default: 0
          selector:
            duration:

        entering_type_off:
          name: Entering Occupancy Detection Type - Off Trigger
          description: >
            For the entering OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the entering sensor control state above) to trigger Entering Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        entering_delay_off:
          name: Entering Occupancy Delay Off Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to cleared.
          default: 0
          selector:
            duration:

        #entering_duration_on_limit:
        #  name: Entering Occupancy Duration Limit
        #  description: >
        #    The maximum number of seconds the entering condition will be active. If delay on is set, duration on will begin after.
        #    If entering condition is cleared before the duration limit is reached, the entering condition will be cleared.
        #    After the duration the entering condtion will be cleared and follow base occupancy or other logic conditions.
        #    The entering condition will need to be cleared first to reset, before the entering condition can be met again.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Occupancy Leaving Conditions ---
    leaving_section:
      name: Occupancy Leaving Conditions
      icon: mdi:door-closed
      collapsed: true
      input:
        use_leaving:
          name: Use Leaving Conditions
          description: >
            Use this if you want to allow entities to trigger an "Leaving" condition.
          default: "use_leaving_disabled"
          selector:
            select:
              options:
                - label: "Enable Leaving Conditions"
                  value: "use_leaving_enabled"
                - label: "Disable Leaving Conditions"
                  value: "use_leaving_disabled"

        leaving_sensors:
          name: Leaving Occupancy
          description: >
            Select a list of motion or occupancy sensors that will trigger smart occupancy to be Cleared.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        leaving_sensor_control_state:
          name: Leaving Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Leaving Conditions.
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        leaving_type_on:
          name: Leaving Occupancy Detection Type - On Trigger
          description: >
            For the leaving ON trigger, choose between Any or All sensors being in the detected state 
            (matching the leaving sensor control state above) to trigger Leaving Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        leaving_delay_on:
          name: Leaving Occupancy Delay On Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to detected.
          default: 0
          selector:
            duration:

        leaving_type_off:
          name: Leaving Occupancy Detection Type - Off Trigger
          description: >
            For the leaving OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the leaving sensor control state above) to trigger Leaving Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        leaving_delay_off:
          name: Leaving Occupancy Delay Off Trigger
          description: >
            The number of seconds to delay before changing smart occupancy to cleared.
          default: 0
          selector:
            duration:

        #leaving_duration_on_limit:
        #  name: Leaving Occupancy Duration Limit
        #  description: >
        #    The maximum number of seconds the leaving condition will be active. If delay on is set, duration on will begin after.
        #    If leaving condition is cleared before the duration limit is reached, the leaving condition will be cleared.
        #    After the duration the leaving condtion will be cleared and follow base occupancy or other logic conditions.
        #    The leaving condition will need to be cleared first to reset, before the leaving condition can be met again.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Detected Occupancy Hold ---
    detected_holds_section:
      name: Detected Occupancy Holds
      icon: mdi:lock-check
      collapsed: true
      input:
        use_detected_hold:
          name: Use Detected Hold Conditions
          description: >
            Enable this if you want to assign entities that will hold smart occupancy to "Detected" state.
          default: "detected_hold_disabled"
          selector:
            select:
              options:
                - label: "Enable Detected Hold Conditions"
                  value: "detected_hold_enabled"
                - label: "Disable Detected Hold Conditions"
                  value: "detected_hold_disabled"

        detected_hold_entities:
          name: Detected Occupancy Hold Entities
          description: >
            Select a list of entities that will hold smart occupancy to detected.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        detected_hold_sensor_control_state:
          name: Detected Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Detected Hold Conditions.
          default: "on"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        detected_hold_type_on:
          name: Detected Occupancy Hold Type - On Trigger
          description: >
            For the detected ON trigger, choose between Any or All sensors being in the detected state 
            (matching the detected sensor control state above) to trigger Detected Hold Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        detected_hold_delay_on:
          name: The time after the Detected Hold will delay before triggering its on state.
          description: >
            The amount of time to hold smart occupancy detected.
          default: 0
          selector:
            duration:

        detected_hold_type_off:
          name: Detected Occupancy Hold Type - Off Trigger
          description: >
            For the detected OFF trigger, choose between Any or All sensors being in the detected state 
            (matching the detected sensor control state above) to trigger Detected Hold Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        detected_hold_delay_off:
          name: The time after the Detected Hold will delay before triggering its off state.
          description: >
            The amount of time to hold smart occupancy detected.
          default: 0
          selector:
            duration:

        #detected_hold_duration_on_limit:
        #  name: Detected Hold Duration Limit
        #  description: >
        #    The maximum number of seconds the Detected Hold condition will be active. If delay on is set, duration on will begin after.
        #    If detected hold is cleared before the duration limit is reached, the hold will be cleared.
        #    After the duration limit is reached, detected hold condtion will be cleared and follow base occupancy or other logic conditions.
        #    The detected hold will need to be cleared first to reset timer and before another hold can be completed.
        #    **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #    EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #  default:
        #    hours: 999
        #    minutes: 0
        #    seconds: 0
        #  selector:
        #    duration:

    # --- Clearing Occupancy Hold ---
    cleared_holds_section:
      name: Cleared Occupancy Holds
      icon: mdi:lock-open
      collapsed: true
      input:
        use_cleared_hold:
          name: Use Clearing Hold Conditions
          description: >
            Enable this if you want to assign entities that will hold smart occupancy to "Cleared" state.
          default: "clearing_hold_disabled"
          selector:
            select:
              options:
                - label: "Enable Clearing Hold Conditions"
                  value: "clearing_hold_enabled"
                - label: "Disable Clearing Hold Conditions"
                  value: "clearing_hold_disabled"
        cleared_hold_entities:
          name: Clearing Occupancy Hold Entities
          description: >
            Select a list of entities that will hold smart occupancy to cleared.
          default: []
          selector:
            entity:
              domain:
                - binary_sensor
                - input_boolean
              multiple: true

        cleared_hold_sensor_control_state:
          name: Detected Sensor Control State
          description: >
            Select the state(s) the sensor(s) selected above must be in to trigger Clearing Hold Conditions.
          default: "off"
          selector:
            select:
              options:
                - label: "ON State"
                  value: "on"
                - label: "OFF State"
                  value: "off"

        cleared_hold_type_on:
          name: Clearing Occupancy Hold Type - On Trigger
          description: >
            For the cleared ON trigger, choose between Any or All sensors being in the cleared state 
            (matching the cleared sensor control state above) to trigger Clearing Hold Condition.
          default: "any"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        cleared_hold_delay_on:
          name: The time after the Clearing Hold will delay before triggering its on state.
          description: >
            The amount of time to hold smart occupancy cleared.
          default: 0
          selector:
            duration:

        cleared_hold_type_off:
          name: Clearing Occupancy Hold Type - Off Trigger
          description: >
            For the cleared OFF trigger, choose between Any or All sensors being in the cleared state 
            (matching the cleared sensor control state above) to trigger Clearing Hold Condition.
          default: "all"
          selector:
            select:
              options:
                - label: "Any"
                  value: "any"
                - label: "All"
                  value: "all"

        cleared_hold_delay_off:
          name: The time after the Clearing Hold will delay before triggering its off state.
          description: >
            The amount of time to hold smart occupancy cleared.
          default: 0
          selector:
            duration:

        #cleared_hold_duration_on_limit:
        #name: Clearing Occupancy Hold Duration
        #description: >
        #  The maximum number of seconds the Clearing Hold condition will be active. If delay on is set, duration on will begin after.
        #  If cleared hold is cleared before the duration limit is reached, the hold will be cleared.
        #  After the duration limit is reached, cleared hold condtion will be cleared and follow base occupancy or other logic conditions.
        #  The cleared hold will need to be cleared first to reset timer and before another hold can be completed.
        #  **WARNING** If using a delay on, ensure the duration limit is in addition to the delay on time or duration events may have timing issues.
        #  EX: If delay on is 2sec, set duration to 5min & 2sec to get the total duration of 5min.
        #default:
        #  hours: 999
        #  minutes: 0
        #  seconds: 0
        #selector:
        #  duration:

    # --- Light Control - Illuminance ---
    lux_section:
      name: Light Control - Illuminance Conditions
      icon: mdi:brightness-6
      collapsed: true
      input:
        use_lux:
          name: Use Illuminance Conditions
          description: >
            Use this if you want an illuminance sensor condition to determine if lights should turn on.
          default: "use_lux_disabled"
          selector:
            select:
              options:
                - label: "Enable Illuminance Conditions"
                  value: "use_lux_enabled"
                - label: "Disable Illuminance Conditions"
                  value: "use_lux_disabled"
        lux_sensor:
          name: Illuminance Sensor
          description: >
            Sensor used for detection of when to turn on/off lights.
          default: []
          selector:
            entity:
              domain: sensor
              device_class: illuminance
              multiple: false
        lux_low_val:
          name: Illuminance Low Lux Value
          description: >
            Set the value when the light will turn on when lux is below this value.
          default: 5
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: lux
              mode: slider
        lux_low_val_delay:
          name: Illuminance Low Lux Delay
          description: >
            Set how long the illuminance level must remain below the Low Lux Value.
          default: 0
          selector:
            duration:
        lux_high_val:
          name: Illuminance High Lux Value
          description: >
            Set the value when the light will turn off when lux is above this value.
          default: 80
          selector:
            number:
              min: 0
              max: 1000
              step: 1
              unit_of_measurement: lux
              mode: slider
        lux_high_val_delay:
          name: Illuminance High Lux Delay
          description: >
            Set how long the illuminance level must remain above the High Lux Value.
          default: 0
          selector:
            duration:

    # --- Sun Elevation ---
    sun_section:
      name: Light Control - Sun Elevation Conditions
      icon: mdi:weather-sunny
      collapsed: true
      input:
        use_sun:
          name: Use Sun Elevation Conditions
          description: >
            Use this if you want to allow the sun elevation to determine if lights should turn on.
          default: "sun_disabled"
          selector:
            select:
              options:
                - label: "Enable Sun Elevation Conditions"
                  value: "sun_enabled"
                - label: "Disable Sun Elevation Conditions"
                  value: "sun_disabled"

        sun_falling:
          name: Sun Elevation Falling
          description: >
            The sun elevation falling refers to the angle between the sun and the horizon when setting.
          default: -1.5
          selector:
            number:
              min: -90
              max: 90
              step: 0.1
              unit_of_measurement: "Â°"

        sun_rising:
          name: Sun Elevation Rising
          description: >
            The sun elevation rising refers to the angle between the sun and the horizon during sunrise.
          default: -1.5
          selector:
            number:
              min: -90
              max: 90
              step: 0.1
              unit_of_measurement: "Â°"

variables:
  base_occ: !input base_occ #input_boolean.back_bedroom_smart_occupancy
  smart_occ_helper: !input smart_occ_helper #back_bedroom_smart_occupancy
  smart_occ_sensor: !input smart_occ_sensor #binary_sensor.smart_occ_back_bedroom
  smart_occ_room_id: >
    {{ smart_occ_sensor.split('.')[1].split('smart_occ_')[1] if 'smart_occ_' in smart_occ_sensor else '' }}
  light_target: !input light_target
  # Split domains for light targets
  light_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'light') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  switch_entities: >
    {% if light_target.entity_id is defined %}
      {{ expand(light_target.entity_id) | selectattr('domain', 'eq', 'switch') | map(attribute='entity_id') | list }}
    {% else %}
      []
    {% endif %}

  scene_entities: >
    {% if light_target.entity_id is defined %}
      {% set scenes = expand(light_target.entity_id) | selectattr('domain', 'eq', 'scene') | map(attribute='entity_id') | list %}
      {% if scenes_scripts_helper | length > 0 and is_state(scenes_scripts_helper, 'off') %}
        {{ scenes }}
      {% elif scenes_scripts_helper | length == 0 %}
        {{ scenes }}
      {% else %}
        []
      {% endif %}
    {% else %}
      []
    {% endif %}

  script_entities: >
    {% if light_target.entity_id is defined %}
      {% set scripts = expand(light_target.entity_id) | selectattr('domain', 'eq', 'script') | map(attribute='entity_id') | list %}
      {% if scenes_scripts_helper | length > 0 and is_state(scenes_scripts_helper, 'off') %}
        {{ scripts }}
      {% elif scenes_scripts_helper | length == 0 %}
        {{ scripts }}
      {% else %}
        []
      {% endif %}
    {% else %}
      []
    {% endif %}

  # --- Automation Control ---
  use_automation_control: !input use_automation_control
  automation_control_entity: !input automation_control_entity
  automation_control_state: !input automation_control_state
  fallback_state_sensor: !input fallback_state_sensor
  use_light_skip: !input use_light_skip
  light_skip_entity: !input light_skip_entity
  light_skip_state: !input light_skip_state

  # --- Smart Occupancy Logic Controls ---
  smart_occ_rising_edge: !input smart_occ_rising_edge
  #smart_occ_rising_delay: !input smart_occ_rising_delay
  smart_occ_falling_edge: !input smart_occ_falling_edge
  #smart_occ_falling_delay: !input smart_occ_falling_delay

  # --- Occupancy Entering Conditions ---
  use_entering: !input use_entering
  entering_sensors: !input entering_sensors
  entering_sensor_control_state: !input entering_sensor_control_state
  #entering_type: !input entering_type
  entering_type_on: !input entering_type_on
  entering_type_off: !input entering_type_off
  entering_delay_on: !input entering_delay_on
  entering_delay_off: !input entering_delay_off
  #entering_duration_on_limit: !input entering_duration_on_limit

  # --- Occupancy Leaving Conditions ---
  use_leaving: !input use_leaving
  leaving_sensors: !input leaving_sensors
  leaving_sensor_control_state: !input leaving_sensor_control_state
  #leaving_type: !input leaving_type
  leaving_type_on: !input leaving_type_on
  leaving_type_off: !input leaving_type_off
  leaving_delay_on: !input leaving_delay_on
  leaving_delay_off: !input leaving_delay_off
  #leaving_duration_on_limit: !input leaving_duration_on_limit

  # -- Detected Occupancy Hold ---
  use_detected_hold: !input use_detected_hold
  detected_hold_entities: !input detected_hold_entities
  detected_hold_sensor_control_state: !input detected_hold_sensor_control_state
  #detected_hold_type: !input detected_hold_type
  detected_hold_type_on: !input detected_hold_type_on
  detected_hold_type_off: !input detected_hold_type_off
  detected_hold_delay_on: !input detected_hold_delay_on
  detected_hold_delay_off: !input detected_hold_delay_off
  #detected_hold_duration_on_limit: !input detected_hold_duration_on_limit

  # Convert inputs to total seconds (handling potential nulls/defaults)
  #detected_hold_delay_on_sec: "{{ (detected_hold_delay_on | default(0)) | int }}"
  #detected_hold_duration_limit_sec: "{{ (detected_hold_duration_on_limit | default(0)) | int }}"

  # The "True Hold Time"
  #total_detected_hold_time_sec: "{{ detected_hold_duration_limit_sec + duration_limit_sec }}"

  # -- Clearing Occupancy Hold ---
  use_cleared_hold: !input use_cleared_hold
  cleared_hold_entities: !input cleared_hold_entities
  cleared_hold_sensor_control_state: !input cleared_hold_sensor_control_state
  #cleared_hold_type: !input cleared_hold_type
  cleared_hold_type_on: !input cleared_hold_type_on
  cleared_hold_type_off: !input cleared_hold_type_off
  cleared_hold_delay_on: !input cleared_hold_delay_on
  cleared_hold_delay_off: !input cleared_hold_delay_off
  #cleared_hold_duration_on_limit: !input cleared_hold_duration_on_limit

  # -- Light Control - Illuminance ---
  use_lux: !input use_lux
  lux_sensor: !input lux_sensor
  lux_low_val: !input lux_low_val
  lux_low_val_delay: !input lux_low_val_delay
  lux_high_val: !input lux_high_val
  lux_high_val_delay: !input lux_high_val_delay

  # -- Light Control - Sun Elevation ---
  use_sun: !input use_sun
  sun_falling: !input sun_falling
  sun_rising: !input sun_rising

triggers:
  - alias: Base Occupancy ON Trigger
    trigger: state
    id: base occupancy on
    entity_id: !input base_occ
    to: "on"
  - alias: Base Occupancy OFF Trigger
    trigger: state
    id: base occupancy off
    entity_id: !input base_occ
    to: "off"
  - alias: Automation Control Enabled
    trigger: state
    id: automation enabled
    entity_id: !input automation_control_entity
    from: !input automation_control_state
  - alias: Automation Control Disabled
    id: automation disabled
    trigger: state
    entity_id: !input automation_control_entity
    to: !input automation_control_state
  #- alias: Rising Edge Trigger (with Delay)
  #  trigger: state
  #  id: rising edge
  #  entity_id:
  #    - !input entering_sensors
  #    - !input leaving_sensors
  #    - !input detected_hold_entities
  #    - !input cleared_hold_entities
  #  from:
  #    - "off"
  #    - unavailable
  #  to:
  #    - "on"
  #  for: !input smart_occ_rising_delay
  #- alias: Falling Edge Trigger (with Delay)
  #  trigger: state
  #  id: falling edge
  #  entity_id:
  #    - !input entering_sensors
  #    - !input leaving_sensors
  #    - !input detected_hold_entities
  #    - !input cleared_hold_entities
  #  from:
  #    - "on"
  #  to:
  #    - "off"
  #  for: !input smart_occ_falling_delay
  - alias: Entering ON (with Delay)
    trigger: state
    id: entering on
    entity_id: !input entering_sensors
    to: !input entering_sensor_control_state
    for: !input entering_delay_on
  - alias: Entering OFF (with Delay)
    trigger: state
    id: entering off
    entity_id: !input entering_sensors
    from: !input entering_sensor_control_state
    for: !input entering_delay_off
  #- alias: Entering ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: entering off
  #  entity_id: !input entering_sensors
  #  to:
  #    - "on" #when on for limit it will trigger entering off id path
  #  for: !input entering_duration_on_limit
  - alias: Leaving ON (with Delay)
    trigger: state
    id: leaving on
    entity_id: !input leaving_sensors
    to: !input leaving_sensor_control_state
    for: !input leaving_delay_on
  - alias: Leaving OFF (with Delay)
    trigger: state
    id: leaving off
    entity_id: !input leaving_sensors
    from: !input leaving_sensor_control_state
    for: !input leaving_delay_off
  #- alias: Leaving ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: leaving off
  #  entity_id: !input leaving_sensors
  #  to:
  #    - "on" #when on for limit it will trigger leaving off id path
  #  for: !input leaving_duration_on_limit
  - alias: Detected Hold ON (with Delay)
    trigger: state
    id: detected hold on
    entity_id: !input detected_hold_entities
    to: !input detected_hold_sensor_control_state
    for: !input detected_hold_delay_on
  - alias: Detected Hold OFF (with Delay)
    trigger: state
    id: detected hold off
    entity_id: !input detected_hold_entities
    from: !input detected_hold_sensor_control_state
    for: !input detected_hold_delay_off
  #- alias: Detected Hold ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: detected hold off
  #  entity_id: !input detected_hold_entities
  #  to:
  #    - "on" #when on for limit it will trigger detected hold off id path
  #  for: !input detected_hold_duration_on_limit
  - alias: Clear Hold ON (with Delay)
    trigger: state
    id: clear hold on
    entity_id: !input cleared_hold_entities
    to: !input cleared_hold_sensor_control_state
    for: !input cleared_hold_delay_on
  - alias: Clear Hold OFF (with Delay)
    trigger: state
    id: clear hold off
    entity_id: !input cleared_hold_entities
    from: !input cleared_hold_sensor_control_state
    for: !input cleared_hold_delay_off
  #- alias: Clear Hold ON (with Time Limit to trigger OFF)
  #  trigger: state
  #  id: clear hold off
  #  to:
  #    - "on"
  #  for: !input cleared_hold_duration_on_limit #when on for limit it will trigger detected hold off id path
  - trigger: state
    entity_id: !input light_skip_entity
    to: !input light_skip_state
    id: light control enabled
  - trigger: state
    entity_id: !input light_skip_entity
    from: !input light_skip_state
    id: light control disabled
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    below: !input sun_falling
    alias: When Elevation from Sun is below is below setting threshold
    id: sun setting threshold
  - trigger: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: !input sun_rising
    alias: When Elevation from Sun is above rising threshold
    id: sun rising threshold
  - trigger: numeric_state
    entity_id: !input lux_sensor
    below: !input lux_low_val
    id: illuminance low limit
  - trigger: numeric_state
    entity_id: !input lux_sensor
    id: illuminance high limit
    above: !input lux_high_val

#Trigger Conditions
conditions:
  - alias: Trigger Conditions
    condition: or
    conditions:
      - alias: Automation Re-Enabled
        condition: and
        conditions:
          - "{{ 'automation_control_enabled' in use_automation_control }}"
          - condition: trigger
            id:
              - automation enabled
          - condition: template
            value_template: "{{ automation_control_entity | length > 0 }}"
      - alias: Automation Disabled
        condition: and
        conditions:
          - condition: trigger
            id:
              - automation disabled
          - "{{ 'automation_control_enabled' in use_automation_control }}"
          - condition: template
            value_template: "{{ automation_control_entity | length > 0 }}"
      #- alias: Rising Edge Trigger
      #  condition: and
      #  conditions:
      #    - condition: trigger
      #      id: rising edge
      #    - or:
      #        - alias: "Base Occupancy is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'base_occ' in smart_occ_rising_edge }}"
      #            - "{{ trigger.entity_id in base_occupancy_sensors }}"
      #        - alias: "Entering is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'entering' in smart_occ_rising_edge }}"
      #            - "{{ trigger.entity_id in entering_sensors }}"
      #        - alias: "Detected Hold is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'detected_hold' in smart_occ_rising_edge }}"
      #            - "{{ trigger.entity_id in detected_hold_entities }}"
      #- alias: Falling Edge Trigger
      #  condition: and
      #  conditions:
      #    - condition: trigger
      #      id: falling edge
      #    - or:
      #        - alias: "Base Occupancy is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'base_occ' in smart_occ_falling_edge }}"
      #            - "{{ trigger.entity_id in base_occupancy_sensors }}"
      #        - alias: "Leaving is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'leaving' in smart_occ_falling_edge }}"
      #            - "{{ trigger.entity_id in leaving_sensors }}"
      #        - alias: "Cleared Hold is selected AND triggered"
      #          condition: and
      #          conditions:
      #            - "{{ 'cleared_hold' in smart_occ_falling_edge }}"
      #            - "{{ trigger.entity_id in cleared_hold_entities }}"
      - alias: Base Occupancy - Toggled
        condition: and
        conditions:
          - condition: trigger
            id:
              - base occupancy on
              - base occupancy off
      - alias: Entering Status - Toggled
        condition: and
        conditions:
          - "{{ 'use_entering_enabled' in use_entering }}"
          - condition: trigger
            id:
              - entering on
              - entering off
          - condition: template
            value_template: "{{ entering_sensors | length > 0 }}"
          - condition: or
            conditions:
              # --- LOGIC FOR "ENTERING ON" TRIGGER ---
              - condition: and
                alias: "Entering ON: Check if sensors match control state with _type_on logic"
                conditions:
                  - condition: trigger
                    id: entering on
                  - condition: or
                    conditions:
                      # Any sensor matches control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ entering_type_on == 'any' }}"
                          - condition: state
                            entity_id: !input entering_sensors
                            state: !input entering_sensor_control_state
                            match: any
                      # All sensors match control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ entering_type_on == 'all' }}"
                          - condition: state
                            entity_id: !input entering_sensors
                            state: !input entering_sensor_control_state
                            match: all

              # --- LOGIC FOR "ENTERING OFF" TRIGGER ---
              - condition: and
                alias: "Entering OFF: Check if sensors are opposite of control state with _type_off logic"
                conditions:
                  - condition: trigger
                    id: entering off
                  - condition: or
                    conditions:
                      # Any sensor is opposite of control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ entering_type_off == 'any' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if entering_sensor_control_state == 'on' else 'on' %}
                              {{ expand(entering_sensors) | selectattr('state', 'eq', opposite_state) | list | count > 0 }}
                      # All sensors are opposite of control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ entering_type_off == 'all' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if entering_sensor_control_state == 'on' else 'on' %}
                              {{ expand(entering_sensors) | selectattr('state', 'eq', opposite_state) | list | count == entering_sensors | count }}
      - alias: Leaving Status - Toggled
        condition: and
        conditions:
          - "{{ 'use_leaving_enabled' in use_leaving }}"
          - condition: trigger
            id:
              - leaving on
              - leaving off
          - condition: template
            value_template: "{{ leaving_sensors | length > 0 }}"
          - condition: or
            conditions:
              # --- LOGIC FOR "LEAVING ON" TRIGGER ---
              - condition: and
                alias: "Leaving ON: Check if sensors match control state with _type_on logic"
                conditions:
                  - condition: trigger
                    id: leaving on
                  - condition: or
                    conditions:
                      # Any sensor matches control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ leaving_type_on == 'any' }}"
                          - condition: state
                            entity_id: !input leaving_sensors
                            state: !input leaving_sensor_control_state
                            match: any
                      # All sensors match control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ leaving_type_on == 'all' }}"
                          - condition: state
                            entity_id: !input leaving_sensors
                            state: !input leaving_sensor_control_state
                            match: all

              # --- LOGIC FOR "LEAVING OFF" TRIGGER ---
              - condition: and
                alias: "Leaving OFF: Check if sensors are opposite of control state with _type_off logic"
                conditions:
                  - condition: trigger
                    id: leaving off
                  - condition: or
                    conditions:
                      # Any sensor is opposite of control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ leaving_type_off == 'any' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if leaving_sensor_control_state == 'on' else 'on' %}
                              {{ expand(leaving_sensors) | selectattr('state', 'eq', opposite_state) | list | count > 0 }}
                      # All sensors are opposite of control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ leaving_type_off == 'all' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if leaving_sensor_control_state == 'on' else 'on' %}
                              {{ expand(leaving_sensors) | selectattr('state', 'eq', opposite_state) | list | count == leaving_sensors | count }}
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ detected_hold_entities | length == 0 }}"
              - condition: state
                entity_id: !input detected_hold_entities
                state:
                  - "off"
                match: any
          - condition: or
            conditions:
              - condition: state
                entity_id: !input base_occ
                state:
                  - "on"
              - condition: template
                value_template: >
                  {{ smart_occ_helper | length > 0 and is_state(smart_occ_helper, 'on') }}
      - alias: Detected Hold Enabled - Toggled
        condition: and
        conditions:
          - "{{ 'detected_hold_enabled' in use_detected_hold }}"
          - condition: trigger
            id:
              - detected hold on
              - detected hold off
          - condition: template
            value_template: "{{ detected_hold_entities | length > 0 }}"
          - condition: or
            conditions:
              # --- LOGIC FOR DETECTED HOLD ON ---
              - condition: and
                alias: "Detected Hold ON: Check if entities match control state with _type_on logic"
                conditions:
                  - condition: trigger
                    id: "detected hold on"
                  - condition: or
                    conditions:
                      # Any entity matches control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ detected_hold_type_on == 'any' }}"
                          - condition: state
                            entity_id: !input detected_hold_entities
                            state: !input detected_hold_sensor_control_state
                            match: any
                      # All entities match control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ detected_hold_type_on == 'all' }}"
                          - condition: state
                            entity_id: !input detected_hold_entities
                            state: !input detected_hold_sensor_control_state
                            match: all

              # --- LOGIC FOR DETECTED HOLD OFF ---
              - condition: and
                alias: "Detected Hold OFF: Check if entities are opposite of control state with _type_off logic"
                conditions:
                  - condition: trigger
                    id: "detected hold off"
                  - condition: or
                    conditions:
                      # Any entity is opposite of control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ detected_hold_type_off == 'any' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if detected_hold_sensor_control_state == 'on' else 'on' %}
                              {{ expand(detected_hold_entities) | selectattr('state', 'eq', opposite_state) | list | count > 0 }}
                      # All entities are opposite of control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ detected_hold_type_off == 'all' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if detected_hold_sensor_control_state == 'on' else 'on' %}
                              {{ expand(detected_hold_entities) | selectattr('state', 'eq', opposite_state) | list | count == detected_hold_entities | count }}
          - alias: "Pass if Cleared Hold is empty OR provided entities are OFF"
            condition: or
            conditions:
              - condition: template
                value_template: "{{ cleared_hold_entities | length == 0 }}"
              - condition: state
                entity_id: !input cleared_hold_entities
                state: "off"
                match: any
      - alias: Clear Hold Enabled - Toggled
        condition: and
        conditions:
          - "{{ 'clearing_hold_enabled' in use_cleared_hold }}"
          - condition: trigger
            id:
              - clear hold on
              - clear hold off
          - condition: template
            value_template: "{{ cleared_hold_entities | length > 0 }}"
          - condition: or
            conditions:
              # --- LOGIC FOR CLEARED HOLD ON ---
              - condition: and
                alias: "Cleared Hold ON: Check if entities match control state with _type_on logic"
                conditions:
                  - condition: trigger
                    id: "clear hold on"
                  - condition: or
                    conditions:
                      # Any entity matches control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ cleared_hold_type_on == 'any' }}"
                          - condition: state
                            entity_id: !input cleared_hold_entities
                            state: !input cleared_hold_sensor_control_state
                            match: any
                      # All entities match control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ cleared_hold_type_on == 'all' }}"
                          - condition: state
                            entity_id: !input cleared_hold_entities
                            state: !input cleared_hold_sensor_control_state
                            match: all

              # --- LOGIC FOR CLEARED HOLD OFF ---
              - condition: and
                alias: "Cleared Hold OFF: Check if entities are opposite of control state with _type_off logic"
                conditions:
                  - condition: trigger
                    id: "clear hold off"
                  - condition: or
                    conditions:
                      # Any entity is opposite of control state (for ANY logic)
                      - condition: and
                        conditions:
                          - "{{ cleared_hold_type_off == 'any' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if cleared_hold_sensor_control_state == 'on' else 'on' %}
                              {{ expand(cleared_hold_entities) | selectattr('state', 'eq', opposite_state) | list | count > 0 }}
                      # All entities are opposite of control state (for ALL logic)
                      - condition: and
                        conditions:
                          - "{{ cleared_hold_type_off == 'all' }}"
                          - condition: template
                            value_template: >
                              {% set opposite_state = 'off' if cleared_hold_sensor_control_state == 'on' else 'on' %}
                              {{ expand(cleared_hold_entities) | selectattr('state', 'eq', opposite_state) | list | count == cleared_hold_entities | count }}
          - alias: "Pass if Detected Hold is empty OR provided entities are OFF"
            condition: or
            conditions:
              - condition: template
                value_template: "{{ detected_hold_entities | length == 0 }}"
              - condition: state
                entity_id: !input detected_hold_entities
                state: "off"
                match: any
      - alias: Illuminance Thresholds
        condition: and
        conditions:
          - condition: template
            value_template: >
              {{ 'use_lux_enabled' in use_lux 
                 and lux_sensor | length > 0 }}
          - condition: trigger
            id:
              - illuminance high limit
              - illuminance low limit
          - condition: template
            value_template: >
              {{ 'light_control_skip_disabled' in use_light_skip
                 or light_skip_entity | length == 0
                 or (light_skip_entity | length > 0 
                     and not is_state(light_skip_entity, light_skip_state)) }}
      - alias: Sun Elevation Thresholds
        condition: and
        conditions:
          - condition: template
            value_template: "{{ 'sun_enabled' in use_sun }}"
          - condition: or
            conditions:
              - condition: template
                value_template: >
                  {{ (use_sun == 'sun_enabled') 
                     and (is_state_attr('sun.sun', 'rising', false)) 
                     and (state_attr('sun.sun','elevation') <= sun_falling | float(90)) }}
              - condition: template
                value_template: >
                  {{ (use_sun == 'sun_enabled') 
                     and (is_state_attr('sun.sun', 'rising', true)) 
                     and (state_attr('sun.sun','elevation') <= sun_rising | float(90)) }}
          - condition: trigger
            id:
              - sun setting threshold
              - sun rising threshold
          - condition: template
            value_template: >
              {{ 'light_control_skip_disabled' in use_light_skip
                 or light_skip_entity | length == 0
                 or (light_skip_entity | length > 0 
                     and not is_state(light_skip_entity, light_skip_state)) }}
  - alias: Automation Control - Enabled
    condition: or
    conditions:
      - alias: Check if Automation Control is bypassed
        condition: template
        value_template: "{{ use_automation_control == 'automation_control_disabled' }}"
      - alias: Check if Entity State does NOT match Control State and Automation Control is enabled
        condition: template
        value_template: >
          {{ use_automation_control == 'automation_control_enabled' and 
            not is_state(automation_control_entity, automation_control_state) }}
      - alias: Automation Disabled Triggered
        condition: trigger
        id:
          - automation disabled

actions:
  - alias: "Smart Occupancy Actions only if Sensor or Helper exists"
    if:
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ smart_occ_sensor != none }}"
          - condition: template
            value_template: "{{ smart_occ_helper != none }}"
    then:
      - alias: Smart Occupancy Actions
        choose:
          - alias: Automation Re-Enabled
            conditions:
              - condition: template
                value_template: "{{ use_automation_control == 'automation_control_enabled' }}"
              - condition: trigger
                id:
                  - automation enabled
            sequence:
              - if:
                  - condition: template
                    value_template: "{{ (smart_occ_sensor | string) != 'none' and (smart_occ_sensor | string) != '' }}"
                then:
                  # 1. Sync the Smart Occupancy Sensor (Event)
                  - if:
                      - condition: template
                        value_template: "{{ smart_occ_sensor != none }}"
                    then:
                      - alias: Fire Update Event - Off
                        event: smart_occupancy_update
                        event_data:
                          target_sensor: "{{ smart_occ_sensor }}"
                          state: "{{ states(base_occ) }}"
                  # 2. Sync the Smart Occupancy Helper (Boolean)
                  - if:
                      - condition: template
                        value_template: "{{ smart_occ_helper != none }}"
                    then:
                      - service: "input_boolean.turn_{{ states(base_occ) }}"
                        target:
                          entity_id: !input smart_occ_helper

          - alias: Automation Disabled
            conditions:
              - condition: template
                value_template: "{{ use_automation_control == 'automation_control_enabled' }}"
              - condition: trigger
                id:
                  - automation disabled
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - On
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "{{ fallback_state_sensor }}"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          # ============================================================================
          # RISING EDGE ACTIONS (Turn ON / Detected)
          # ============================================================================

          - alias: Base Occupancy - Detected
            conditions:
              - condition: trigger
                id:
                  - base occupancy on
              # RISING EDGE FILTER: Only proceed if 'base_occ' is in the rising edge list
              - condition: template
                value_template: "{{ 'base_occ' in smart_occ_rising_edge }}"
              # Cleared hold check (prevents turning on if cleared hold is active)
              - condition: template
                value_template: >
                  {{ cleared_hold_entities | length == 0
                     or (cleared_hold_entities | length > 0 
                         and expand(cleared_hold_entities) | selectattr('state', 'eq', 'off') | list | length == cleared_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - On
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "on"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ smart_occ_helper }}"
          ###
          ### Also look at adding 3rd. option if these are not provide have another varible that can help with the light logic state of a variable to pass when that logic goes
          ###

          - alias: Entering Condition - On
            conditions:
              - condition: trigger
                id:
                  - entering on
              # RISING EDGE FILTER: Only proceed if 'entering' is in the rising edge list
              - condition: template
                value_template: "{{ 'entering' in smart_occ_rising_edge }}"
              # Cleared hold check
              - condition: template
                value_template: >
                  {{ cleared_hold_entities | length == 0
                     or (cleared_hold_entities | length > 0 
                         and expand(cleared_hold_entities) | selectattr('state', 'eq', 'off') | list | length == cleared_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - On
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "on"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          - alias: Leaving Condition - Off
            conditions:
              - condition: trigger
                id:
                  - leaving off
              # RISING EDGE FILTER: Only proceed if 'leaving' is in the rising edge list
              - condition: template
                value_template: "{{ 'leaving' in smart_occ_rising_edge }}"
              # Cleared hold check
              - condition: template
                value_template: >
                  {{ cleared_hold_entities | length == 0
                     or (cleared_hold_entities | length > 0 
                         and expand(cleared_hold_entities) | selectattr('state', 'eq', 'off') | list | length == cleared_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - On
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "on"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          - alias: Detected Hold - On
            conditions:
              - condition: trigger
                id:
                  - detected hold on
              # RISING EDGE FILTER: Only proceed if 'detected_hold' is in the rising edge list
              - condition: template
                value_template: "{{ 'rising_edge' in smart_detected_hold_rising_edge }}"
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - On
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "on"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          # ============================================================================
          # FALLING EDGE ACTIONS (Turn OFF / Cleared)
          # ============================================================================

          - alias: Base Occupancy - Clear
            conditions:
              - condition: trigger
                id:
                  - base occupancy off
              # FALLING EDGE FILTER: Only proceed if 'base_occ' is in the falling edge list
              - condition: template
                value_template: "{{ 'base_occ' in smart_occ_falling_edge }}"

              ### And condtions here that if entering ON and leaving off are in smart_occ_rising_edge and active then skip this condition

              # Detected hold check (prevents turning off if detected hold is active)
              - condition: template
                value_template: >
                  {{ detected_hold_entities | length == 0
                     or (detected_hold_entities | length > 0 
                         and expand(detected_hold_entities) | selectattr('state', 'eq', 'off') | list | length == detected_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Off
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "off"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          ### Need to add Entering Condtion - OFF with the same condtions of if leaving OFF and base occ are in smart occ_rising and active then skip this condtion
          ###
          ### Review the existing Entering Condition - OFF and see if it should be location here in the new "Rising Edge" actions/triggers
          ###
          ### Also look at
          ###

          - alias: Leaving Condition - On
            conditions:
              - condition: trigger
                id:
                  - leaving on
              # FALLING EDGE FILTER: Only proceed if 'leaving' is in the falling edge list
              - condition: template
                value_template: "{{ 'leaving' in smart_occ_falling_edge }}"

              ### And condtions here that if entering ON and base_occ are in smart_occ_rising_edge and active then skip this condition

              # Detected hold check
              - condition: template
                value_template: >
                  {{ detected_hold_entities | length == 0
                     or (detected_hold_entities | length > 0 
                         and expand(detected_hold_entities) | selectattr('state', 'eq', 'off') | list | length == detected_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Off
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "off"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          - alias: Cleared Hold - On
            conditions:
              - condition: trigger
                id:
                  - clear hold on
              # FALLING EDGE FILTER: Only proceed if 'cleared_hold' is in the falling edge list
              - condition: template
                value_template: "{{ 'cleared_hold' in smart_occ_falling_edge }}"
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Off
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "off"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ smart_occ_helper }}"

          # ============================================================================
          # HOLD RELEASE ACTIONS (Return to Base Occupancy)
          # ============================================================================

          - alias: Detected Hold - Off
            conditions:
              - condition: trigger
                id:
                  - detected hold off
              # NO EDGE FILTER - Hold releases always sync to base_occ
              # FALLING EDGE FILTER: Only proceed if 'detected_hold' is in the falling edge list
              - condition: template
                value_template: "{{ 'detected_hold' in smart_occ_falling_edge }}"
            sequence:
              # 1. Sync the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Sync to Base
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "{{ states(base_occ) }}"
              # 2. Sync the Smart Occupancy Helper (Boolean)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: "input_boolean.turn_{{ states(base_occ) }}"
                    target:
                      entity_id: !input smart_occ_helper

          - alias: Cleared Hold - Off
            conditions:
              - condition: trigger
                id:
                  - clear hold off
              # NO EDGE FILTER - Hold releases always sync to base_occ
              # RISING EDGE FILTER: Only proceed if 'cleared_hold' is in the rising edge list
              - condition: template
                value_template: "{{ 'cleared_hold' in smart_occ_rising_edge }}"
            sequence:
              # 1. Sync the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Sync to Base
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "{{ states(base_occ) }}"
              # 2. Sync the Smart Occupancy Helper (Boolean)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: "input_boolean.turn_{{ states(base_occ) }}"
                    target:
                      entity_id: !input smart_occ_helper

          # ============================================================================
          # OFF ACTIONS THAT NEED EDGE FILTERS
          # ============================================================================

          - alias: Entering Condition - Off
            conditions:
              - condition: trigger
                id:
                  - entering off
              # FALLING EDGE FILTER: Only proceed if 'entering' is in the falling edge list
              - condition: template
                value_template: "{{ 'entering' in smart_occ_falling_edge }}"
              # Detected hold check
              - condition: template
                value_template: >
                  {{ detected_hold_entities | length == 0
                     or (detected_hold_entities | length > 0 
                         and expand(detected_hold_entities) | selectattr('state', 'eq', 'off') | list | length == detected_hold_entities | length) }}
            sequence:
              # 1. Handle the Smart Occupancy Sensor (Event)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_sensor != none }}"
                then:
                  - alias: Fire Update Event - Off
                    event: smart_occupancy_update
                    event_data:
                      target_sensor: "{{ smart_occ_sensor }}"
                      state: "off"
              # 2. Handle the Smart Occupancy Helper (Service Call)
              - if:
                  - condition: template
                    value_template: "{{ smart_occ_helper != none }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ smart_occ_helper }}"

  # ============================================================================
  # LIGHT CONTROL SECTION (Remains largely the same, just add edge filters to trigger conditions)
  # ============================================================================

  - alias: If Light Control is Enabled
    if:
      - condition: template
        value_template: >
          {{ 'light_control_skip_disabled' in use_light_skip
             or light_skip_entity | length == 0
             or (light_skip_entity | length > 0 
              and not is_state(light_skip_entity, light_skip_state)) }}
    then:
      - alias: "Light On Conditions"
        if:
          - condition: and
            conditions:
              # --- SUN SECTION ---
              - alias: "Sun Logic (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - alias: Use Sun is disabled
                    condition: template
                    value_template: "{{ use_sun == 'sun_disabled' }}"
                  - alias: Sun Elevation Thresholds or Triggered
                    condition: or
                    conditions:
                      - condition: trigger
                        id:
                          - sun setting threshold
                      - condition: and
                        alias: Sun Elevation Levels
                        conditions:
                          - alias: If Elevation is below the Setting Below Limit
                            condition: or
                            conditions:
                              - condition: state
                                entity_id: sun.sun
                                attribute: rising
                                state: false
                              - condition: numeric_state
                                entity_id: sun.sun
                                attribute: elevation
                                below: !input sun_falling
                          - alias: If Elevation is below Rising Above Limit
                            condition: or
                            conditions:
                              - condition: state
                                entity_id: sun.sun
                                attribute: rising
                                state: true
                              - condition: numeric_state
                                entity_id: sun.sun
                                attribute: elevation
                                below: !input sun_rising
              # --- LUX SECTION ---
              - alias: "Lux Logic (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - alias: Use Lux is disabled
                    condition: template
                    value_template: "{{ use_lux == 'use_lux_disabled' or lux_sensor | length == 0 }}"
                  - alias: Illuminance Thresholds or Triggered
                    condition: or
                    conditions:
                      - condition: trigger
                        id:
                          - illuminance low limit
                      - alias: Illuminance Levels
                        condition: and
                        conditions:
                          - condition: numeric_state
                            entity_id: !input lux_sensor
                            below: !input lux_low_val
        then:
          - alias: Light Control Actions - On
            choose:
              - alias: "Master ON Sequence"
                conditions:
                  - condition: and
                    conditions:
                      # 1. Trigger Filter WITH EDGE CHECKS
                      - condition: or
                        conditions:
                          - condition: and
                            conditions:
                              - condition: trigger
                                id: base occupancy on
                              - "{{ 'base_occ' in smart_occ_rising_edge }}"
                          - condition: and
                            conditions:
                              - condition: trigger
                                id: entering on
                              - "{{ 'entering' in smart_occ_rising_edge }}"
                          - condition: and
                            conditions:
                              - condition: trigger
                                id: detected hold on
                              - "{{ 'detected_hold' in smart_occ_rising_edge }}"
                          - condition: and
                            conditions:
                              - condition: trigger
                                id: leaving off
                              - "{{ 'leaving' in smart_occ_rising_edge }}"
                          - condition: and
                            conditions:
                              - condition: trigger
                                id: clear hold off
                              - "{{ 'clear_hold' in smart_occ_rising_edge }}"

                      # 2. Occupancy Safety Gate
                      - condition: or
                        conditions:
                          - condition: trigger
                            id:
                              - entering on
                              - detected hold on
                          - condition: template
                            alias: "Base Occupancy is ON"
                            value_template: "{{ base_occ | length > 0 and is_state(base_occ, 'on') }}"
                          - condition: template
                            alias: "Smart Sensor is ON"
                            value_template: "{{ smart_occ_sensor != none and is_state(smart_occ_sensor, 'on') }}"
                          - condition: template
                            alias: "Smart Helper is ON"
                            value_template: "{{ smart_occ_helper | length > 0 and is_state(smart_occ_helper, 'on') }}"

                      # 3. Hold Entity Gate
                      - condition: or
                        alias: "Cleared Hold Check"
                        conditions:
                          - condition: template
                            value_template: "{{ cleared_hold_entities | length == 0 }}"
                          - condition: state
                            entity_id: !input cleared_hold_entities
                            state: "off"
                            match: any
                sequence:
                  # Turn on lights
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ light_entities | length > 0 }}"
                        sequence:
                          - action: light.turn_on
                            target:
                              entity_id: "{{ light_entities }}"
                  # Turn on switches
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ switch_entities | length > 0 }}"
                        sequence:
                          - action: switch.turn_on
                            target:
                              entity_id: "{{ switch_entities }}"
                  # Activate scenes
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ scene_entities | length > 0 }}"
                        sequence:
                          - action: scene.turn_on
                            target:
                              entity_id: "{{ scene_entities }}"
                  # Run scripts
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ script_entities | length > 0 }}"
                        sequence:
                          - action: script.turn_on
                            target:
                              entity_id: "{{ script_entities }}"

      - alias: "Light Off Conditions"
        if:
          - condition: and
            conditions:
              # --- SUN SECTION ---
              - alias: "Sun Logic Off (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - condition: template
                    alias: "Sun is disabled"
                    value_template: "{{ use_sun == 'sun_disabled' }}"
                  - alias: "Sun Elevation Thresholds or Triggered"
                    condition: or
                    conditions:
                      - condition: trigger
                        id:
                          - sun rising threshold
                      - condition: and
                        alias: "Sun Elevation Levels"
                        conditions:
                          - alias: "Afternoon Check: Sun is falling but still high"
                            condition: or
                            conditions:
                              - condition: state
                                entity_id: sun.sun
                                attribute: rising
                                state: true
                              - condition: numeric_state
                                entity_id: sun.sun
                                attribute: elevation
                                above: !input sun_falling
                          - alias: "Morning Check: Sun is rising and high enough"
                            condition: or
                            conditions:
                              - condition: state
                                entity_id: sun.sun
                                attribute: rising
                                state: false
                              - condition: numeric_state
                                entity_id: sun.sun
                                attribute: elevation
                                above: !input sun_rising

              # --- LUX SECTION ---
              - alias: "Lux Logic Off (Pass if disabled OR conditions met)"
                condition: or
                conditions:
                  - condition: template
                    alias: "Lux is disabled"
                    value_template: "{{ 'use_lux_enabled' not in use_lux or lux_sensor | length == 0 }}"
                  - alias: "Illuminance Thresholds or Triggered"
                    condition: or
                    conditions:
                      - condition: trigger
                        id:
                          - illuminance high limit
                      - alias: "Illuminance Levels"
                        condition: and
                        conditions:
                          - condition: numeric_state
                            entity_id: !input lux_sensor
                            above: !input lux_high_val
        then:
          - alias: Light Control Actions - Off
            choose:
              - alias: "Master Clear/Off Sequence"
                conditions:
                  # 1. Trigger Filter WITH EDGE CHECKS
                  - condition: or
                    conditions:
                      - condition: and
                        conditions:
                          - condition: trigger
                            id: base occupancy off
                          - "{{ 'base_occ' in smart_occ_falling_edge }}"
                      - condition: and
                        conditions:
                          - condition: trigger
                            id: leaving on
                          - "{{ 'leaving' in smart_occ_falling_edge }}"
                      - condition: and
                        conditions:
                          - condition: trigger
                            id: entering off
                          - "{{ 'entering' in smart_occ_falling_edge }}"
                      - condition: and
                        conditions:
                          - condition: trigger
                            id: clear hold on
                          - "{{ 'cleared_hold' in smart_occ_falling_edge }}"
                      - condition: and
                        conditions:
                          - condition: trigger
                            id: detected hold off
                          # Hold releases don't need edge filter

                  # 2. Occupancy Safety Gate
                  - condition: or
                    alias: "Bypass safety for specific triggers, otherwise ensure room is empty"
                    conditions:
                      - condition: trigger
                        id:
                          - base occupancy off
                          - leaving on
                          - entering off
                          - clear hold on
                          - detected hold off
                      - condition: and
                        alias: "Ensure all active occupancy systems are actually OFF"
                        conditions:
                          - condition: template
                            value_template: "{{ base_occ | length == 0 or is_state(base_occ, 'off') }}"
                          - condition: template
                            value_template: "{{ smart_occ_sensor == none or is_state(smart_occ_sensor, 'off') }}"
                          - condition: template
                            value_template: "{{ smart_occ_helper | length == 0 or is_state(smart_occ_helper, 'off') }}"

                  # 3. Hold Entity Gate
                  - condition: or
                    alias: "Detected Hold Bypass"
                    conditions:
                      - "{{ detected_hold_entities | length == 0 }}"
                      - condition: state
                        entity_id: !input detected_hold_entities
                        state: "off"
                        match: all
                sequence:
                  # Turn off lights
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ light_entities | length > 0 }}"
                        sequence:
                          - action: light.turn_off
                            target:
                              entity_id: "{{ light_entities }}"
                  # Turn off switches
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ switch_entities | length > 0 }}"
                        sequence:
                          - action: switch.turn_off
                            target:
                              entity_id: "{{ switch_entities }}"
mode: single
